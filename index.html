<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leveling System</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0d0f;
    --surface: #141417;
    --surface2: #1a1a1f;
    --surface3: #202028;
    --border: #2a2a35;
    --border2: #333345;
    --accent: #c8102e;
    --accent2: #e8263d;
    --gold: #d4a017;
    --gold2: #f0c040;
    --text: #e8e8f0;
    --text2: #9090a8;
    --text3: #5a5a72;
    --pink: #e040a0;
    --blue: #4080e0;
    --green: #40c880;
    --purple: #9060d0;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* TOPBAR */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    height: 52px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .topbar-logo {
    font-family: 'Cinzel', serif;
    font-size: 15px;
    font-weight: 700;
    letter-spacing: 3px;
    color: var(--gold);
    text-transform: uppercase;
  }

  .topbar-logo span {
    color: var(--accent);
  }

  .topbar-nav {
    display: flex;
    gap: 4px;
  }

  .nav-btn {
    padding: 6px 16px;
    background: none;
    border: none;
    color: var(--text2);
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .nav-btn:hover { color: var(--text); background: var(--surface2); }
  .nav-btn.active { color: var(--gold); background: rgba(212,160,23,0.08); }

  .topbar-xp {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--gold2);
  }

  .topbar-xp .xp-icon { color: var(--gold); }

  /* SECTIONS */
  .section { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
  .section.active { display: block; }
  #section-calendar.active {
    display: flex;
    padding: 0;
    max-width: 100%;
    margin: 0;
    height: calc(100vh - 52px);
  }
  .section.active { display: block; }

  /* ===================== DASHBOARD ===================== */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 300px 1fr 280px;
    gap: 16px;
    align-items: start;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text2);
  }

  .card-header .dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent);
  }

  /* PLAYER CARD */
  .player-card {}

  .player-portrait-wrap {
    position: relative;
    height: 200px;
    overflow: hidden;
    background: linear-gradient(180deg, #1a0a10 0%, #0d0508 100%);
    cursor: pointer;
  }

  .player-portrait-wrap img {
    width: 100%; height: 100%;
    object-fit: cover;
    object-position: top;
    opacity: 0.85;
    transition: opacity 0.3s;
  }

  .player-portrait-wrap:hover img { opacity: 1; }

  .portrait-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(0deg, var(--surface) 0%, transparent 50%);
  }

  .portrait-upload-hint {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(13,13,15,0.7);
    color: var(--text2);
    font-size: 12px;
    letter-spacing: 1px;
    opacity: 0;
    transition: opacity 0.2s;
    flex-direction: column;
    gap: 6px;
  }

  .player-portrait-wrap:hover .portrait-upload-hint { opacity: 1; }

  .portrait-placeholder {
    width: 100%; height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 64px;
    background: linear-gradient(135deg, #1a0a14 0%, #0d0d1a 100%);
  }

  .player-info {
    padding: 14px 16px;
  }

  .player-level-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(212,160,23,0.1);
    border: 1px solid rgba(212,160,23,0.3);
    border-radius: 4px;
    padding: 3px 10px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 2px;
    color: var(--gold);
    margin-bottom: 8px;
  }

  .player-name {
    font-family: 'Cinzel', serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .player-name:hover .edit-icon { opacity: 1; }

  .edit-icon {
    font-size: 12px;
    color: var(--text3);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .player-title {
    font-size: 12px;
    color: var(--accent2);
    letter-spacing: 1.5px;
    font-weight: 500;
    margin-bottom: 14px;
  }

  /* XP BAR */
  .xp-section { margin-bottom: 14px; }
  .xp-label {
    display: flex; justify-content: space-between;
    font-size: 11px; color: var(--text2); margin-bottom: 6px;
    font-weight: 600; letter-spacing: 1px;
  }

  .xp-bar {
    height: 6px;
    background: var(--surface3);
    border-radius: 3px;
    overflow: hidden;
  }

  .xp-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--gold) 0%, var(--gold2) 100%);
    border-radius: 3px;
    transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
    position: relative;
  }

  .xp-fill::after {
    content: '';
    position: absolute;
    top: 0; right: 0;
    width: 4px; height: 100%;
    background: white;
    opacity: 0.5;
    border-radius: 2px;
    animation: pulse-xp 2s ease-in-out infinite;
  }

  @keyframes pulse-xp {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 0; }
  }

  /* VITALS */
  .vitals { display: flex; flex-direction: column; gap: 8px; padding: 14px 16px; border-top: 1px solid var(--border); }

  .vital-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .vital-icon { font-size: 14px; width: 18px; text-align: center; }

  .vital-label {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--text2);
    width: 70px;
  }

  .vital-bar-wrap { flex: 1; }

  .vital-bar {
    height: 5px;
    background: var(--surface3);
    border-radius: 3px;
    overflow: hidden;
  }

  .vital-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s;
  }

  .vital-fill.energy { background: linear-gradient(90deg, #e84040, #ff6060); }
  .vital-fill.focus { background: linear-gradient(90deg, #4060e8, #60a0ff); }
  .vital-fill.mood { background: linear-gradient(90deg, #e060c0, #ff90e0); }

  .vital-dots {
    display: flex;
    gap: 2px;
  }

  .vital-dot {
    width: 14px; height: 14px;
    border-radius: 3px;
    background: var(--surface3);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.15s;
  }

  .vital-dot.energy-dot.filled { background: #e84040; border-color: #e84040; }
  .vital-dot.focus-dot.filled { background: #4060e8; border-color: #4060e8; }
  .vital-dot.mood-dot.filled { background: #e060c0; border-color: #e060c0; }

  .vital-num {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--text2);
    width: 28px;
    text-align: right;
  }

  /* RADAR */
  .radar-card { }

  .radar-wrap {
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* TODAY'S QUESTS */
  .quests-section { }

  .quest-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  .quest-item:hover { background: var(--surface2); }
  .quest-item:last-child { border-bottom: none; }

  .quest-check {
    width: 16px; height: 16px;
    border: 1px solid var(--border2);
    border-radius: 3px;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    transition: all 0.2s;
  }

  .quest-check:hover { border-color: var(--gold); }
  .quest-check.done { background: var(--gold); border-color: var(--gold); color: #000; }

  .quest-info { flex: 1; }
  .quest-name {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 3px;
  }

  .quest-name.done-text { text-decoration: line-through; color: var(--text3); }

  .quest-tags { display: flex; gap: 4px; flex-wrap: wrap; }

  .tag {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.8px;
    padding: 2px 6px;
    border-radius: 3px;
  }

  .tag.stat { background: rgba(160,80,210,0.15); color: #b070e0; border: 1px solid rgba(160,80,210,0.2); }
  .tag.diff-easy { background: rgba(64,200,128,0.1); color: #40c880; border: 1px solid rgba(64,200,128,0.2); }
  .tag.diff-medium { background: rgba(212,160,23,0.1); color: var(--gold2); border: 1px solid rgba(212,160,23,0.2); }
  .tag.diff-hard { background: rgba(200,16,46,0.1); color: var(--accent2); border: 1px solid rgba(200,16,46,0.2); }
  .tag.prio-sss { background: rgba(200,16,46,0.15); color: #ff4060; border: 1px solid rgba(200,16,46,0.3); }
  .tag.prio-a { background: rgba(212,160,23,0.1); color: var(--gold); border: 1px solid rgba(212,160,23,0.2); }
  .tag.prio-b { background: rgba(64,128,224,0.1); color: #6090f0; border: 1px solid rgba(64,128,224,0.2); }
  .tag.prio-c { background: rgba(80,80,100,0.1); color: var(--text2); border: 1px solid var(--border); }

  .quest-xp {
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    color: var(--gold);
    white-space: nowrap;
    margin-top: 2px;
  }

  /* RIGHT PANEL */
  .right-panel { display: flex; flex-direction: column; gap: 16px; }

  .stat-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 16px;
    border-bottom: 1px solid var(--border);
  }

  .stat-row:last-child { border-bottom: none; }

  .stat-name {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    color: var(--text2);
    width: 80px;
  }

  .stat-bar-wrap { flex: 1; }
  .stat-bar { height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
  .stat-fill { height: 100%; background: linear-gradient(90deg, #e040a0, #ff70c0); border-radius: 2px; transition: width 0.6s; }

  .stat-val {
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
    color: var(--text);
    width: 28px;
    text-align: right;
  }

  /* ARC CARD */
  .arc-card { }
  .arc-name {
    padding: 12px 16px;
    font-family: 'Cinzel', serif;
    font-size: 14px;
    color: var(--gold2);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .arc-mantras {
    padding: 0 16px 14px;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .arc-mantra {
    font-size: 12px;
    color: var(--text2);
    font-style: italic;
    padding-left: 10px;
    border-left: 2px solid var(--accent);
  }

  /* RANK BADGE */
  .rank-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
  }

  .rank-S { color: #ff4060; }
  .rank-A { color: var(--gold2); }
  .rank-B { color: #6090f0; }
  .rank-C { color: var(--text2); }

  /* ADD QUEST BTN */
  .add-quest-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: none;
    border: none;
    border-top: 1px solid var(--border);
    color: var(--text3);
    font-family: 'Rajdhani', sans-serif;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    cursor: pointer;
    width: 100%;
    text-align: left;
    transition: all 0.2s;
  }

  .add-quest-btn:hover { color: var(--text); background: var(--surface2); }

  /* ===================== PROFILE SECTION ===================== */
  .profile-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
    align-items: start;
  }

  .profile-left { display: flex; flex-direction: column; gap: 16px; }
  .profile-right { display: flex; flex-direction: column; gap: 16px; }

  .big-portrait {
    height: 340px;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    background: linear-gradient(135deg, #1a0a14 0%, #0d0d1a 100%);
  }

  .big-portrait img {
    width: 100%; height: 100%;
    object-fit: cover;
    object-position: top;
    opacity: 0.9;
  }

  .big-portrait .portrait-overlay {
    background: linear-gradient(0deg, var(--surface) 0%, transparent 60%);
  }

  .big-portrait .portrait-placeholder {
    font-size: 96px;
  }

  .big-portrait:hover .portrait-upload-hint { opacity: 1; }

  .achievements-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    padding: 14px 16px;
  }

  .achievement {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
    text-align: center;
  }

  .achievement-icon { font-size: 20px; margin-bottom: 4px; }
  .achievement-name { font-size: 10px; font-weight: 600; letter-spacing: 1px; color: var(--text2); text-transform: uppercase; }
  .achievement-locked { opacity: 0.3; }

  .profile-stats-detail {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    padding: 14px 16px;
  }

  .stat-detail-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 12px;
  }

  .stat-detail-name {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.5px;
    color: var(--text3);
    text-transform: uppercase;
    margin-bottom: 4px;
  }

  .stat-detail-val {
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px;
    color: var(--text);
  }

  .stat-detail-sub {
    font-size: 10px;
    color: var(--text3);
    margin-top: 2px;
  }

  /* ===================== MISSIONS SECTION ===================== */
  .missions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }

  .section-title {
    font-family: 'Cinzel', serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .mission-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 10px;
    transition: border-color 0.2s;
    cursor: pointer;
  }

  .mission-item:hover { border-color: var(--border2); }

  .mission-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 8px;
  }

  .mission-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
  }

  .mission-meta {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }

  .mission-progress-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }

  .mission-progress-bar {
    flex: 1;
    height: 4px;
    background: var(--surface3);
    border-radius: 2px;
    overflow: hidden;
  }

  .mission-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--gold));
    border-radius: 2px;
    transition: width 0.5s;
  }

  .mission-dates {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Share Tech Mono', monospace;
  }

  .mission-xp-reward {
    font-size: 12px;
    color: var(--gold);
    font-weight: 600;
    font-family: 'Share Tech Mono', monospace;
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(4px);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 10px;
    width: 480px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }

  .modal-title {
    font-family: 'Cinzel', serif;
    font-size: 15px;
    color: var(--gold);
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text2);
    cursor: pointer;
    font-size: 18px;
    line-height: 1;
  }

  .modal-close:hover { color: var(--text); }

  .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 14px; }

  .form-group { display: flex; flex-direction: column; gap: 6px; }

  .form-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text2);
  }

  .form-input, .form-select, .form-textarea {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 14px;
    padding: 8px 12px;
    outline: none;
    transition: border-color 0.2s;
  }

  .form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--border2);
  }

  .form-select option { background: var(--surface2); }
  .form-textarea { resize: vertical; min-height: 70px; }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .xp-preview {
    background: rgba(212,160,23,0.08);
    border: 1px solid rgba(212,160,23,0.2);
    border-radius: 6px;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .xp-preview-label { font-size: 11px; color: var(--text2); font-weight: 600; letter-spacing: 1px; }
  .xp-preview-val { font-family: 'Share Tech Mono', monospace; font-size: 18px; color: var(--gold2); }

  .btn-primary {
    background: var(--accent);
    border: none;
    border-radius: 6px;
    color: white;
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    padding: 10px 20px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary:hover { background: var(--accent2); }

  .btn-secondary {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text2);
    font-family: 'Rajdhani', sans-serif;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 1px;
    padding: 10px 20px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-secondary:hover { color: var(--text); border-color: var(--border2); }

  .btn-row { display: flex; gap: 8px; justify-content: flex-end; }

  /* ===================== CONFIG SECTION ===================== */
  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }

  .config-card { }

  .stats-config-list { padding: 14px 16px; display: flex; flex-direction: column; gap: 8px; }

  .stat-config-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .stat-config-item .form-input { flex: 1; }

  .stat-color-dot {
    width: 12px; height: 12px; border-radius: 50%;
    flex-shrink: 0;
  }

  .remove-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text3);
    cursor: pointer;
    width: 28px; height: 28px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    transition: all 0.2s;
  }

  .remove-btn:hover { color: var(--accent); border-color: var(--accent); }

  /* NOTIFICATION */
  .notification {
    position: fixed;
    top: 70px; right: 20px;
    background: var(--surface2);
    border: 1px solid var(--gold);
    border-radius: 8px;
    padding: 12px 16px;
    z-index: 300;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--gold2);
    transform: translateX(120%);
    transition: transform 0.4s cubic-bezier(0.4,0,0.2,1);
    max-width: 280px;
  }

  .notification.show { transform: translateX(0); }
  .notification-icon { font-size: 18px; }

  /* Level up overlay */
  .levelup-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 400;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }

  .levelup-overlay.show { display: flex; animation: fadeIn 0.4s ease; }

  @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

  .levelup-text {
    font-family: 'Cinzel', serif;
    font-size: 48px;
    font-weight: 700;
    color: var(--gold2);
    text-align: center;
    animation: scaleIn 0.5s cubic-bezier(0.4,0,0.2,1);
  }

  @keyframes scaleIn {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .levelup-sub { font-size: 16px; color: var(--text2); letter-spacing: 3px; font-weight: 500; }
  .levelup-close { margin-top: 20px; }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 4px 0;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  /* EMPTY STATE */
  .empty-state {
    padding: 30px 16px;
    text-align: center;
    color: var(--text3);
    font-size: 13px;
    font-style: italic;
  }

  /* Radar SVG styles */
  .radar-polygon { fill: rgba(200,16,46,0.15); stroke: var(--accent); stroke-width: 1.5; }
  .radar-grid { fill: none; stroke: var(--border2); stroke-width: 0.8; }
  .radar-axis { stroke: var(--border); stroke-width: 0.8; }
  .radar-label { font-family: 'Rajdhani', sans-serif; font-size: 10px; fill: var(--text2); font-weight: 600; letter-spacing: 1px; }
  .radar-dot { fill: var(--accent); }

  /* ===================== CALENDAR ===================== */
  .calendar-layout {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .cal-sidebar {
    width: 240px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
    overflow-y: auto;
    border-right: 1px solid var(--border);
    background: var(--surface);
    padding: 12px;
    gap: 12px;
  }

  .cal-mini { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }

  .cal-mini-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }

  .cal-mini-title {
    font-family: 'Cinzel', serif; font-size: 13px; color: var(--gold);
  }

  .cal-mini-nav {
    background: none; border: none; color: var(--text2); cursor: pointer;
    font-size: 14px; padding: 2px 6px; border-radius: 3px;
    transition: color 0.15s;
  }
  .cal-mini-nav:hover { color: var(--text); }

  .cal-mini-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; }

  .cal-mini-day-label {
    font-size: 9px; font-weight: 700; letter-spacing: 1px;
    color: var(--text3); text-align: center; padding: 2px 0;
  }

  .cal-mini-day {
    font-size: 11px; text-align: center; padding: 4px 2px;
    border-radius: 4px; cursor: pointer; color: var(--text2);
    transition: all 0.15s; font-family: 'Share Tech Mono', monospace;
  }

  .cal-mini-day:hover { background: var(--surface2); color: var(--text); }
  .cal-mini-day.today { background: var(--accent); color: white; font-weight: 700; }
  .cal-mini-day.selected { outline: 1px solid var(--gold); color: var(--gold); }
  .cal-mini-day.has-events::after {
    content: '‚Ä¢'; display: block; font-size: 8px;
    color: var(--gold); margin-top: -4px;
  }
  .cal-mini-day.other-month { opacity: 0.3; }

  /* Main calendar */
  .cal-main {
    flex: 1;
    background: var(--surface);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .cal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .cal-date-title {
    font-family: 'Cinzel', serif; font-size: 16px; color: var(--text);
  }

  .cal-view-btns { display: flex; gap: 4px; }
  .cal-view-btn {
    background: none; border: 1px solid var(--border); border-radius: 4px;
    color: var(--text2); font-family: 'Rajdhani', sans-serif;
    font-size: 11px; font-weight: 600; letter-spacing: 1px;
    padding: 4px 10px; cursor: pointer; transition: all 0.15s;
  }
  .cal-view-btn:hover { color: var(--text); border-color: var(--border2); }
  .cal-view-btn.active { color: var(--gold); border-color: var(--gold); background: rgba(212,160,23,0.08); }

  /* Day view (24h) */
  .cal-day-view {
    display: flex; flex: 1; overflow: hidden;
  }

  .cal-time-col {
    width: 52px; flex-shrink: 0;
    overflow-y: scroll; border-right: 1px solid var(--border);
  }

  .cal-time-col::-webkit-scrollbar { display: none; }

  .cal-time-label {
    height: 60px; display: flex; align-items: flex-start;
    justify-content: flex-end; padding: 4px 8px 0 0;
    font-family: 'Share Tech Mono', monospace; font-size: 10px;
    color: var(--text3); flex-shrink: 0;
  }

  .cal-events-col {
    flex: 1; overflow-y: scroll; position: relative;
    cursor: crosshair;
  }

  .cal-hour-row {
    height: 60px; border-bottom: 1px solid var(--border);
    position: relative; flex-shrink: 0;
  }

  .cal-hour-row:hover { background: rgba(255,255,255,0.01); }

  .cal-half-line {
    position: absolute; top: 50%; left: 0; right: 0;
    border-top: 1px dashed rgba(255,255,255,0.04);
  }

  /* Events on calendar */
  .cal-event {
    position: absolute;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: 600;
    overflow: hidden;
    cursor: pointer;
    transition: filter 0.12s, box-shadow 0.12s;
    z-index: 2;
    border-left: 3px solid rgba(255,255,255,0.3);
    user-select: none;
    box-sizing: border-box;
  }

  .cal-event:hover {
    filter: brightness(1.18);
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    z-index: 10;
  }

  .cal-event.type-daily     { background: rgba(200,16,46,0.3);   border-color: #e8263d; color: #ffd0d6; }
  .cal-event.type-habit     { background: rgba(40,180,100,0.28); border-color: #40c880; color: #a0f0c0; }
  .cal-event.type-objective { background: rgba(212,160,23,0.28); border-color: #d4a017; color: #f0d070; }
  .cal-event.type-sidequest { background: rgba(160,80,220,0.28); border-color: #b060f0; color: #e0b0ff; }
  .cal-event.type-block     { color: #c0d0ff; }
  .cal-event.overdue        { opacity: 0.5; border-style: dashed; }

  /* Penalty banner */
  .penalty-banner {
    background: rgba(200,16,46,0.12);
    border: 1px solid rgba(200,16,46,0.35);
    border-radius: 8px;
    padding: 10px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    font-size: 12px;
    color: var(--text2);
  }
  .penalty-banner .penalty-icon { font-size: 18px; flex-shrink: 0; }
  .penalty-banner .penalty-text { flex: 1; line-height: 1.4; }
  .penalty-banner .penalty-xp   { font-family: 'Share Tech Mono', monospace; color: var(--accent); font-weight: 700; white-space: nowrap; }
  .penalty-forgive-btn {
    background: none;
    border: 1px solid rgba(212,160,23,0.4);
    border-radius: 4px;
    color: var(--gold);
    font-family: 'Rajdhani', sans-serif;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.15s;
  }
  .penalty-forgive-btn:hover { background: rgba(212,160,23,0.1); }

  /* Side quest streak badge */
  .sq-streak-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(160,80,220,0.15);
    border: 1px solid rgba(160,80,220,0.3);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 11px;
    color: #c080ff;
    font-family: 'Share Tech Mono', monospace;
  }

  .cal-event-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.3;
  }

  .cal-event-time {
    font-size: 10px;
    opacity: 0.8;
    font-family: 'Share Tech Mono', monospace;
    font-weight: 400;
  }

  /* Current time line */
  .cal-now-line {
    position: absolute; left: 0; right: 0; height: 2px;
    background: var(--accent2); z-index: 5; pointer-events: none;
  }

  .cal-now-dot {
    position: absolute; left: -4px; top: -4px;
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--accent2);
  }

  /* Week view */
  .cal-week-view { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

  .cal-week-header {
    display: grid; grid-template-columns: 52px repeat(7, 1fr);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
  }

  .cal-week-day-header {
    padding: 8px 4px; text-align: center;
    font-size: 11px; font-weight: 600; letter-spacing: 1px;
    color: var(--text2); border-left: 1px solid var(--border);
  }

  .cal-week-day-header.today-col { color: var(--gold); }

  .cal-week-body {
    flex: 1; overflow-y: scroll;
    display: grid; grid-template-columns: 52px repeat(7, 1fr);
  }

  .cal-week-col {
    position: relative; border-left: 1px solid var(--border);
    cursor: crosshair;
  }

  /* Drag-select ghost */
  .cal-drag-ghost {
    position: absolute; left: 4px; right: 4px;
    background: rgba(212,160,23,0.15); border: 1px dashed var(--gold);
    border-radius: 5px; z-index: 10; pointer-events: none;
  }

  /* Habit tracker sidebar */
  .habit-tracker-card { }

  .habit-day-row {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 0; border-bottom: 1px solid var(--border);
  }
  .habit-day-row:last-child { border-bottom: none; }

  .habit-name { font-size: 12px; color: var(--text); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .habit-streak { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--gold); }

  .habit-check-dot {
    width: 16px; height: 16px; border-radius: 50%;
    border: 1px solid var(--border2); cursor: pointer;
    transition: all 0.2s; flex-shrink: 0;
  }

  .habit-check-dot.done { background: var(--green); border-color: var(--green); }
  .habit-check-dot.missed { background: rgba(200,16,46,0.3); border-color: var(--accent); }

  .block-color-opt {
    width: 28px; height: 28px; border-radius: 6px; cursor: pointer;
    border: 2px solid transparent; transition: all 0.15s;
    flex-shrink: 0;
  }
  .block-color-opt:hover { transform: scale(1.1); }
  .block-color-opt.selected { border-color: white; }

  /* ===================== EVALUACIONES ===================== */
  .evals-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
  .eval-metric-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 14px 16px; }
  .eval-metric { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; position: relative; overflow: hidden; }
  .eval-metric::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
  .eval-metric.green::before  { background: var(--green); }
  .eval-metric.gold::before   { background: var(--gold); }
  .eval-metric.accent::before { background: var(--accent); }
  .eval-metric.purple::before { background: var(--purple); }
  .eval-metric.blue::before   { background: var(--blue); }
  .eval-metric-val { font-family: 'Share Tech Mono', monospace; font-size: 28px; font-weight: 700; color: var(--text); line-height: 1; margin-bottom: 4px; }
  .eval-metric-label { font-size: 10px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); }
  .eval-metric-sub { font-size: 11px; color: var(--text3); margin-top: 4px; }
  .eval-period-tabs { display: flex; gap: 2px; padding: 12px 16px; border-bottom: 1px solid var(--border); }
  .eval-period-btn { background: none; border: 1px solid var(--border); border-radius: 4px; color: var(--text2); font-family: 'Rajdhani', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 1px; padding: 4px 12px; cursor: pointer; transition: all 0.15s; }
  .eval-period-btn:hover { color: var(--text); border-color: var(--border2); }
  .eval-period-btn.active { color: var(--gold); border-color: var(--gold); background: rgba(212,160,23,0.08); }
  .kaizen-label { font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--text2); display: flex; align-items: center; gap: 6px; }
  .kaizen-textarea { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: 'Rajdhani', sans-serif; font-size: 13px; padding: 10px 12px; outline: none; resize: vertical; min-height: 80px; transition: border-color 0.2s; line-height: 1.5; width: 100%; box-sizing: border-box; }
  .kaizen-textarea:focus { border-color: var(--border2); }
  .kaizen-log-item { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; margin-bottom: 10px; }
  .kaizen-log-item:hover { border-color: var(--border2); }
  .kaizen-log-date { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--gold); margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; }
  .kaizen-log-section { margin-bottom: 8px; }
  .kaizen-log-section-title { font-size: 10px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text3); margin-bottom: 3px; }
  .kaizen-log-text { font-size: 12px; color: var(--text2); line-height: 1.5; }
  .kaizen-improvement-tag { display: inline-flex; align-items: center; gap: 4px; background: rgba(144,96,208,0.12); border: 1px solid rgba(144,96,208,0.25); border-radius: 4px; padding: 3px 8px; font-size: 11px; color: #b080e0; margin: 2px; }
  .kaizen-task-item { display: flex; align-items: center; gap: 8px; padding: 7px 0; border-bottom: 1px solid var(--border); }
  .kaizen-task-item:last-child { border-bottom: none; }
  .kaizen-task-check { width: 15px; height: 15px; border: 1px solid var(--border2); border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 9px; flex-shrink: 0; transition: all 0.15s; }
  .kaizen-task-check:hover { border-color: var(--purple); }
  .kaizen-task-check.done { background: var(--purple); border-color: var(--purple); color: white; }
  .kaizen-task-name { font-size: 12px; color: var(--text); flex: 1; }
  .kaizen-task-name.done-text { text-decoration: line-through; color: var(--text3); }
  .bar-row { display: flex; align-items: center; gap: 8px; padding: 5px 16px; }
  .bar-label { font-size: 11px; color: var(--text2); width: 80px; text-align: right; flex-shrink: 0; }
  .bar-track { flex: 1; height: 7px; background: var(--surface3); border-radius: 4px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 4px; transition: width 0.7s cubic-bezier(0.4,0,0.2,1); }
  .bar-val { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--text2); width: 32px; }

  /* Automations */
  .auto-day-label {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    cursor: pointer; user-select: none;
  }

  .auto-day-label input[type="checkbox"] { display: none; }

  .auto-day-label span {
    width: 30px; height: 30px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
    background: var(--surface3); border: 1px solid var(--border);
    color: var(--text3); cursor: pointer; transition: all 0.15s;
  }

  .auto-day-label input:checked + span {
    background: rgba(64,128,224,0.2);
    border-color: var(--blue);
    color: #80b0ff;
  }

  .automation-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    transition: border-color 0.15s;
  }

  .automation-item:hover { border-color: var(--border2); }

  .automation-item-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 8px;
  }

  .automation-item-name {
    font-size: 14px; font-weight: 600; color: var(--text);
    display: flex; align-items: center; gap: 8px;
  }

  .automation-type-badge {
    font-size: 10px; font-weight: 600; letter-spacing: 1px;
    padding: 2px 7px; border-radius: 3px;
  }

  .automation-type-badge.task       { background: rgba(200,16,46,0.15);  color: var(--accent2); }
  .automation-type-badge.habit      { background: rgba(64,200,128,0.15); color: var(--green); }
  .automation-type-badge.block      { background: rgba(64,80,160,0.15);  color: #80a0ff; }
  .automation-type-badge.sidequest  { background: rgba(160,80,220,0.15); color: #c080ff; }

  .automation-item-meta {
    font-size: 11px; color: var(--text3);
    font-family: 'Share Tech Mono', monospace;
    display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 8px;
  }

  .automation-days {
    display: flex; gap: 3px;
  }

  .auto-day-dot {
    width: 20px; height: 20px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-size: 9px; font-weight: 700;
    background: var(--surface3); color: var(--text3);
  }

  .auto-day-dot.active { background: rgba(64,128,224,0.2); color: #80b0ff; }


  /* tabs in missions */
  .tab-row {
    display: flex;
    gap: 2px;
    margin-bottom: 14px;
    border-bottom: 1px solid var(--border);
  }

  .tab-btn {
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    padding: 8px 16px;
    color: var(--text2);
    font-family: 'Rajdhani', sans-serif;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--gold); border-bottom-color: var(--gold); }
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-logo">Leveling <span>System</span></div>
  <div class="topbar-nav">
    <button class="nav-btn active" onclick="showSection('dashboard')">Dashboard</button>
    <button class="nav-btn" onclick="showSection('profile')">Perfil</button>
    <button class="nav-btn" onclick="showSection('missions')">Misiones</button>
    <button class="nav-btn" onclick="showSection('calendar')">Calendario</button>
    <button class="nav-btn" onclick="showSection('evals')">Evaluaciones</button>
    <button class="nav-btn" onclick="showSection('config')">Config</button>
  </div>
  <div class="topbar-xp">
    <span class="xp-icon">‚óÜ</span>
    <span id="topbar-xp-val">0 XP</span>
    &nbsp;¬∑&nbsp;
    <span id="topbar-level">Nv. 1</span>
  </div>
</div>

<!-- NOTIFICATION -->
<div class="notification" id="notification">
  <span class="notification-icon" id="notification-icon">‚ö°</span>
  <span id="notification-text">+50 XP obtenido</span>
</div>

<!-- LEVEL UP OVERLAY -->
<div class="levelup-overlay" id="levelup-overlay">
  <div class="levelup-text">¬°LEVEL UP!</div>
  <div class="levelup-sub" id="levelup-new-level">NIVEL 2</div>
  <button class="btn-primary levelup-close" onclick="closeLevelUp()">Continuar</button>
</div>

<!-- ======== DASHBOARD ======== -->
<div class="section active" id="section-dashboard">
  <div class="dashboard-grid">

    <!-- LEFT: PLAYER CARD -->
    <div>
      <div class="card player-card">
        <div class="player-portrait-wrap" onclick="triggerPortraitUpload('portrait-input')">
          <div class="portrait-placeholder" id="portrait-placeholder">‚öîÔ∏è</div>
          <img id="portrait-img" src="" alt="" style="display:none;">
          <div class="portrait-overlay"></div>
          <div class="portrait-upload-hint">
            <span>üì∑</span>
            <span>Cambiar retrato</span>
          </div>
        </div>
        <input type="file" id="portrait-input" accept="image/*" style="display:none" onchange="handlePortraitChange(this,'portrait-img','portrait-placeholder')">

        <div class="player-info">
          <div class="player-level-badge">‚ñ≤ NIVEL <span id="player-level-num">1</span></div>
          <div class="player-name" onclick="editName()">
            <span id="player-name-text">Protagonista</span>
            <span class="edit-icon">‚úé</span>
          </div>
          <div class="player-title" id="player-title-text">Aprendiz del Sistema</div>
          <div class="xp-section">
            <div class="xp-label">
              <span>XP</span>
              <span><span id="current-xp">0</span> / <span id="next-xp">100</span></span>
            </div>
            <div class="xp-bar"><div class="xp-fill" id="xp-bar-fill" style="width:0%"></div></div>
          </div>
        </div>

        <!-- VITALS -->
        <div class="vitals">
          <div class="vital-row">
            <span class="vital-icon">‚ù§Ô∏è</span>
            <span class="vital-label">Energ√≠a</span>
            <div class="vital-dots" id="energy-dots"></div>
            <span class="vital-num" id="energy-num">7/10</span>
          </div>
          <div class="vital-row">
            <span class="vital-icon">üî∑</span>
            <span class="vital-label">Foco</span>
            <div class="vital-dots" id="focus-dots"></div>
            <span class="vital-num" id="focus-num">6/10</span>
          </div>
          <div class="vital-row">
            <span class="vital-icon">üå∏</span>
            <span class="vital-label">Humor</span>
            <div class="vital-dots" id="mood-dots"></div>
            <span class="vital-num" id="mood-num">8/10</span>
          </div>
        </div>
      </div>

      <!-- ARC CARD -->
      <div class="card arc-card" style="margin-top:16px;">
        <div class="card-header"><span class="dot"></span> Arco Activo</div>
        <div class="arc-name">üí∞ <span id="arc-name-text">Sin arco activo</span></div>
        <div class="arc-mantras" id="arc-mantras"></div>
      </div>
    </div>

    <!-- CENTER: RADAR + QUESTS -->
    <div style="display:flex;flex-direction:column;gap:16px;">
      <!-- RADAR -->
      <div class="card">
        <div class="card-header"><span class="dot"></span> Estad√≠sticas</div>
        <div class="radar-wrap">
          <svg id="radar-svg" viewBox="0 0 300 260" width="300" height="260">
            <!-- Generated by JS -->
          </svg>
        </div>
      </div>

      <!-- TODAY'S QUESTS -->
      <div class="card">
        <div class="card-header"><span class="dot"></span> Misiones de Hoy</div>
        <div id="today-quests-list"></div>
        <button class="add-quest-btn" onclick="openQuestModal()">+ Nueva misi√≥n r√°pida</button>
      </div>
    </div>

    <!-- RIGHT: STATS + SUMMARY -->
    <div class="right-panel">
      <div class="card">
        <div class="card-header"><span class="dot"></span> Stats</div>
        <div id="stats-list-dash"></div>
      </div>

      <div class="card">
        <div class="card-header"><span class="dot"></span> Resumen</div>
        <div style="padding:14px 16px;display:flex;flex-direction:column;gap:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:12px;color:var(--text2);font-weight:600;letter-spacing:1px;">COMPLETADAS HOY</span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:14px;" id="completed-today">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:12px;color:var(--text2);font-weight:600;letter-spacing:1px;">MISIONES TOTALES</span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:14px;" id="total-missions-count">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:12px;color:var(--text2);font-weight:600;letter-spacing:1px;">RANGO ACTUAL</span>
            <span class="rank-badge rank-C" id="rank-badge">‚óà C</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:12px;color:var(--text2);font-weight:600;letter-spacing:1px;">XP TOTAL</span>
            <span style="font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--gold);" id="total-xp-earned">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======== PROFILE ======== -->
<div class="section" id="section-profile">
  <div class="profile-grid">
    <div class="profile-left">
      <div class="card">
        <div class="big-portrait" onclick="triggerPortraitUpload('portrait-input2')">
          <div class="portrait-placeholder" id="portrait-placeholder2">‚öîÔ∏è</div>
          <img id="portrait-img2" src="" alt="" style="display:none;">
          <div class="portrait-overlay"></div>
          <div class="portrait-upload-hint">
            <span>üì∑</span>
            <span>Cambiar retrato</span>
          </div>
        </div>
        <input type="file" id="portrait-input2" accept="image/*" style="display:none" onchange="handlePortraitChange(this,'portrait-img2','portrait-placeholder2')">
        <div class="player-info">
          <div class="player-level-badge">‚ñ≤ NIVEL <span id="profile-level-num">1</span></div>
          <div class="player-name" onclick="editName()">
            <span id="profile-name-text">Protagonista</span>
            <span class="edit-icon">‚úé</span>
          </div>
          <div class="player-title" id="profile-title-text">Aprendiz del Sistema</div>
          <div class="xp-section">
            <div class="xp-label">
              <span>XP</span>
              <span><span id="profile-current-xp">0</span> / <span id="profile-next-xp">100</span></span>
            </div>
            <div class="xp-bar"><div class="xp-fill" id="profile-xp-bar" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><span class="dot"></span> Logros</div>
        <div class="achievements-grid" id="achievements-grid">
          <!-- filled by JS -->
        </div>
      </div>
    </div>

    <div class="profile-right">
      <div class="card">
        <div class="card-header"><span class="dot"></span> Estad√≠sticas Detalladas</div>
        <div class="profile-stats-detail" id="profile-stats-detail">
          <!-- filled by JS -->
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="dot"></span> Radar</div>
        <div class="radar-wrap">
          <svg id="radar-svg2" viewBox="0 0 300 260" width="300" height="260"></svg>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><span class="dot" style="background:var(--accent)"></span> Historial de Penalizaciones</div>
        <div id="penalty-history-list" style="padding:8px 0;max-height:280px;overflow-y:auto;"></div>
        <div id="penalty-history-empty" class="empty-state">Sin penalizaciones registradas</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="dot"></span> Historial de Misiones</div>
        <div id="history-list" style="padding:10px 0;"></div>
        <div id="history-empty" class="empty-state">Completa misiones para ver el historial</div>
      </div>
    </div>
  </div>
</div>

<!-- ======== MISSIONS ======== -->
<div class="section" id="section-missions">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div>
      <div style="font-family:'Cinzel',serif;font-size:20px;color:var(--text);margin-bottom:4px;">Misiones & Objetivos</div>
      <div style="font-size:13px;color:var(--text2);">Crea y gestiona tus misiones, h√°bitos y objetivos</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn-secondary" onclick="openQuestModal('habit')">+ H√°bito</button>
      <button class="btn-secondary" onclick="openQuestModal('daily')">+ Misi√≥n</button>
      <button class="btn-secondary" style="color:#c080ff;border-color:rgba(160,80,220,0.4);" onclick="openQuestModal('sidequest')">+ Side Quest üéÆ</button>
      <button class="btn-primary" onclick="openQuestModal('objective')">+ Objetivo</button>
    </div>
  </div>

  <div class="tab-row">
    <button class="tab-btn active" onclick="switchMissionsTab('all',this)">Todas</button>
    <button class="tab-btn" onclick="switchMissionsTab('daily',this)">Diarias</button>
    <button class="tab-btn" onclick="switchMissionsTab('sidequest',this)">Side Quests üéÆ</button>
    <button class="tab-btn" onclick="switchMissionsTab('habit',this)">H√°bitos</button>
    <button class="tab-btn" onclick="switchMissionsTab('objective',this)">Objetivos</button>
    <button class="tab-btn" onclick="switchMissionsTab('done',this)">Completadas</button>
  </div>

  <div id="missions-list-container"></div>
</div>


<!-- ======== EVALUACIONES ======== -->
<div class="section" id="section-evals">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <div>
      <div style="font-family:'Cinzel',serif;font-size:20px;color:var(--text);margin-bottom:4px;">Evaluaciones</div>
      <div style="font-size:13px;color:var(--text2);">M√©tricas de rendimiento y reflexi√≥n Kaizen</div>
    </div>
  </div>

  <!-- M√âTRICAS -->
  <div class="card" style="margin-bottom:20px;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);">
      <div style="display:flex;align-items:center;gap:8px;font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text2);">
        <span class="dot" style="background:var(--gold);width:6px;height:6px;border-radius:50%;display:inline-block;"></span> M√©tricas de Rendimiento
      </div>
      <div class="eval-period-tabs" style="padding:0;border:none;">
        <button class="eval-period-btn active" onclick="setEvalPeriod('day',this)">Hoy</button>
        <button class="eval-period-btn" onclick="setEvalPeriod('week',this)">Esta semana</button>
        <button class="eval-period-btn" onclick="setEvalPeriod('month',this)">Este mes</button>
      </div>
    </div>
    <div class="eval-metric-grid" id="eval-metrics-grid"></div>
    <div style="padding:0 16px 16px;">
      <div style="font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:10px;padding-left:80px;">Misiones por stat</div>
      <div id="eval-stat-bars"></div>
    </div>
  </div>

  <!-- KAIZEN -->
  <div style="font-family:'Cinzel',serif;font-size:16px;color:var(--gold);margin-bottom:14px;display:flex;align-items:center;gap:10px;">
    ‚ôæ Kaizen ‚Äî Mejora Continua
  </div>

  <div style="display:grid;grid-template-columns:1fr 320px;gap:20px;align-items:start;">
    <!-- FORM -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);">
        <div style="font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text2);display:flex;align-items:center;gap:8px;">
          <span class="dot"></span>
          <span id="kaizen-form-date-label">Reflexi√≥n de hoy</span>
        </div>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="date" id="kaizen-date-picker" class="form-input" style="width:150px;font-size:12px;padding:4px 8px;" onchange="loadKaizenForDate()">
          <button class="btn-secondary" style="padding:4px 10px;font-size:11px;" onclick="newKaizenEntry()">+ Nuevo</button>
        </div>
      </div>
      <div style="padding:16px;display:flex;flex-direction:column;gap:14px;">
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label class="kaizen-label"><span>üìã</span> Resumen del d√≠a</label>
          <textarea class="kaizen-textarea" id="k-summary" placeholder="¬øC√≥mo fue el d√≠a en general? ¬øQu√© hiciste? ¬øC√≥mo te sentiste?" style="min-height:70px;"></textarea>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
          <div style="display:flex;flex-direction:column;gap:6px;">
            <label class="kaizen-label"><span>‚úÖ</span> Qu√© sali√≥ bien y por qu√©</label>
            <textarea class="kaizen-textarea" id="k-good" placeholder="Describe los logros del d√≠a y la raz√≥n de su √©xito..."></textarea>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <label class="kaizen-label"><span>‚ùå</span> Qu√© sali√≥ mal y por qu√©</label>
            <textarea class="kaizen-textarea" id="k-bad" placeholder="¬øQu√© no funcion√≥? ¬øQu√© caus√≥ los fallos?"></textarea>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label class="kaizen-label"><span>üî∫</span> Qu√© debo mejorar</label>
          <textarea class="kaizen-textarea" id="k-improve" placeholder="¬øQu√© cambiar√≠as? ¬øQu√© h√°bito o comportamiento quieres trabajar?" style="min-height:70px;"></textarea>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <label class="kaizen-label"><span>‚ö°</span> Tareas de Mejora</label>
          <div id="k-tasks-list" style="border:1px solid var(--border);border-radius:6px;padding:4px 10px;min-height:40px;background:var(--surface2);"></div>
          <div style="display:flex;gap:8px;">
            <input class="form-input" id="k-task-input" placeholder="Nueva tarea de mejora..." style="flex:1;" onkeydown="if(event.key==='Enter')addKaizenTask()">
            <button class="btn-secondary" onclick="addKaizenTask()">+ A√±adir</button>
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:4px;border-top:1px solid var(--border);">
          <button class="btn-secondary" onclick="deleteKaizenEntry()" id="k-delete-btn" style="display:none;color:var(--accent);border-color:var(--accent);">Eliminar</button>
          <button class="btn-primary" onclick="saveKaizenEntry()">Guardar reflexi√≥n</button>
        </div>
      </div>
    </div>

    <!-- SIDEBAR: log + pending tasks -->
    <div style="display:flex;flex-direction:column;gap:16px;">
      <div class="card">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text2);display:flex;align-items:center;gap:8px;">
          <span class="dot" style="background:var(--purple);"></span> Tareas de Mejora Pendientes
        </div>
        <div id="kaizen-pending-tasks" style="padding:6px 12px;"></div>
        <div id="kaizen-pending-empty" class="empty-state">No hay tareas de mejora pendientes</div>
      </div>
      <div class="card">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);font-size:11px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text2);display:flex;align-items:center;gap:8px;">
          <span class="dot"></span> Historial Kaizen
        </div>
        <div id="kaizen-history" style="padding:8px 0;max-height:400px;overflow-y:auto;"></div>
        <div id="kaizen-history-empty" class="empty-state">Empieza tu primera reflexi√≥n</div>
      </div>
    </div>
  </div>
</div>


<!-- ======== CONFIG ======== -->
<div class="section" id="section-config">
  <div style="font-family:'Cinzel',serif;font-size:20px;color:var(--text);margin-bottom:20px;">Configuraci√≥n</div>
  <div class="config-grid">

    <!-- PLAYER CONFIG -->
    <div style="display:flex;flex-direction:column;gap:16px;">
      <div class="card config-card">
        <div class="card-header"><span class="dot"></span> Jugadora</div>
        <div style="padding:14px 16px;display:flex;flex-direction:column;gap:12px;">
          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input class="form-input" id="config-name" placeholder="Tu nombre..." oninput="updateNameFromConfig()">
          </div>
          <div class="form-group">
            <label class="form-label">T√≠tulo Activo</label>
            <select class="form-select" id="config-title" onchange="updateTitleFromConfig()">
              <option>Aprendiz del Sistema</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Arco Activo</label>
            <input class="form-input" id="config-arc-name" placeholder="Nombre del arco..." oninput="updateArc()">
          </div>
          <div class="form-group">
            <label class="form-label">Mantras del Arco (uno por l√≠nea)</label>
            <textarea class="form-textarea" id="config-arc-mantras" placeholder="Ej: Prioriza tus necesidades&#10;Act√∫a sin dudar" oninput="updateArc()"></textarea>
          </div>
        </div>
      </div>

      <div class="card config-card">
        <div class="card-header"><span class="dot"></span> T√≠tulos</div>
        <div style="padding:14px 16px;display:flex;flex-direction:column;gap:10px;">
          <div style="font-size:11px;color:var(--text3);letter-spacing:1px;margin-bottom:2px;">Los t√≠tulos se desbloquean autom√°ticamente seg√∫n nivel o logro.</div>
          <div id="titles-list"></div>
          <div style="border-top:1px solid var(--border);padding-top:10px;display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;gap:8px;">
              <input class="form-input" id="new-title-input" placeholder="Nombre del t√≠tulo..." style="flex:1;">
              <input class="form-input" id="new-title-icon" placeholder="üéñÔ∏è" style="width:52px;text-align:center;">
              <input type="color" id="new-title-color" value="#e8263d" title="Color" style="width:36px;height:36px;border:none;background:none;cursor:pointer;border-radius:6px;padding:2px;">
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <select class="form-select" id="new-title-unlock-type" style="flex:1;" onchange="toggleTitleUnlockInput()">
                <option value="manual">Manual (disponible ya)</option>
                <option value="level">Por nivel</option>
                <option value="achievement">Por logro</option>
              </select>
              <input class="form-input" id="new-title-unlock-val" placeholder="Nv. o clave" style="width:90px;display:none;">
            </div>
            <button class="btn-secondary" onclick="addTitle()">+ A√±adir t√≠tulo</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STATS CONFIG -->
    <div style="display:flex;flex-direction:column;gap:16px;">
      <div class="card config-card">
        <div class="card-header"><span class="dot"></span> Estad√≠sticas</div>
        <div class="stats-config-list" id="stats-config-list">
          <!-- filled by JS -->
        </div>
        <div style="padding:0 16px 14px;display:flex;gap:8px;">
          <input class="form-input" id="new-stat-name" placeholder="Nueva estad√≠stica..." style="flex:1;">
          <button class="btn-secondary" onclick="addStat()">+ A√±adir</button>
        </div>
      </div>

      <div class="card config-card">
        <div class="card-header"><span class="dot"></span> Rangos & Niveles</div>
        <div style="padding:14px 16px;display:flex;flex-direction:column;gap:6px;">
          <div style="font-size:11px;color:var(--text3);margin-bottom:6px;letter-spacing:1px;">√çCONO ¬∑ NOMBRE ¬∑ NIVEL M√çNIMO</div>
          <div id="ranks-display" style="display:flex;flex-direction:column;gap:4px;"></div>
        </div>
      </div>

      <div class="card config-card">
        <div class="card-header"><span class="dot"></span> Datos</div>
        <div style="padding:14px 16px;display:flex;flex-direction:column;gap:8px;">
          <button class="btn-secondary" onclick="exportData()">Exportar datos (JSON)</button>
          <button class="btn-secondary" onclick="document.getElementById('import-input').click()">Importar datos (JSON)</button>
          <input type="file" id="import-input" accept=".json" style="display:none" onchange="importData(this)">
          <button class="btn-secondary" style="color:var(--accent);border-color:var(--accent);" onclick="if(confirm('¬øBorrar todos los datos?')){resetData()}">Resetear todo</button>
        </div>
      </div>
    </div>

  </div>


  <!-- AUTOMATIZACIONES -->
  <div style="margin-top:28px;">
    <div style="font-family:'Cinzel',serif;font-size:16px;color:var(--gold);margin-bottom:14px;display:flex;align-items:center;gap:10px;">
      ‚öô Automatizaciones
    </div>
    <div style="display:grid;grid-template-columns:380px 1fr;gap:16px;align-items:start;">

      <!-- FORM -->
      <div class="card">
        <div class="card-header"><span class="dot" style="background:var(--blue)"></span> Nueva Automatizaci√≥n</div>
        <div style="padding:14px 16px;display:flex;flex-direction:column;gap:12px;">

          <div class="form-group">
            <label class="form-label">Nombre</label>
            <input class="form-input" id="auto-name" placeholder="Nombre del evento automatizado...">
          </div>

          <div class="form-group">
            <label class="form-label">Tipo</label>
            <select class="form-select" id="auto-type" onchange="updateAutoType()">
              <option value="task">Tarea (Misi√≥n Diaria)</option>
              <option value="sidequest">Side Quest üéÆ</option>
              <option value="habit">H√°bito</option>
              <option value="block">Bloque de Tiempo</option>
            </select>
          </div>

          <div id="auto-task-fields">
            <div class="form-row" style="margin-bottom:12px;">
              <div class="form-group">
                <label class="form-label">Prioridad</label>
                <select class="form-select" id="auto-priority">
                  <option value="SSS">SSS ‚Äî Cr√≠tica</option>
                  <option value="A">A ‚Äî Alta</option>
                  <option value="B" selected>B ‚Äî Media</option>
                  <option value="C">C ‚Äî Baja</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Dificultad</label>
                <select class="form-select" id="auto-difficulty">
                  <option value="hard">Dif√≠cil</option>
                  <option value="medium" selected>Media</option>
                  <option value="easy">F√°cil</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label class="form-label">Estad√≠stica relacionada</label>
              <select class="form-select" id="auto-stat">
                <option value="">Sin estad√≠stica</option>
              </select>
            </div>
          </div>

          <div id="auto-block-fields" style="display:none;">
            <div class="form-group">
              <label class="form-label">Color del bloque</label>
              <div style="display:flex;gap:8px;flex-wrap:wrap;" id="auto-block-color-picker"></div>
            </div>
          </div>

          <div style="height:1px;background:var(--border);"></div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha inicio</label>
              <input class="form-input" type="date" id="auto-start-date">
            </div>
            <div class="form-group">
              <label class="form-label">Fecha fin</label>
              <input class="form-input" type="date" id="auto-end-date">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Hora inicio</label>
              <input class="form-input" type="time" id="auto-start-time" value="09:00">
            </div>
            <div class="form-group">
              <label class="form-label">Hora fin</label>
              <input class="form-input" type="time" id="auto-end-time" value="10:00">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">D√≠as de la semana</label>
            <div style="display:flex;gap:6px;margin-top:4px;">
              <label class="auto-day-label"><input type="checkbox" class="auto-day" value="1" checked><span>L</span></label>
              <label class="auto-day-label"><input type="checkbox" class="auto-day" value="2" checked><span>M</span></label>
              <label class="auto-day-label"><input type="checkbox" class="auto-day" value="3" checked><span>X</span></label>
              <label class="auto-day-label"><input type="checkbox" class="auto-day" value="4" checked><span>J</span></label>
              <label class="auto-day-label"><input type="checkbox" class="auto-day" value="5" checked><span>V</span></label>
              <label class="auto-day-label"><input type="checkbox" class="auto-day" value="6"><span>S</span></label>
              <label class="auto-day-label"><input type="checkbox" class="auto-day" value="0"><span>D</span></label>
            </div>
          </div>

          <div class="btn-row" style="flex-direction:column;gap:6px;">
            <button class="btn-primary" id="auto-save-btn" onclick="saveAutomation()" style="width:100%;">‚ö° Crear Automatizaci√≥n</button>
            <button class="btn-secondary" id="auto-cancel-btn" onclick="cancelAutoEdit()" style="width:100%;display:none;">‚úï Cancelar edici√≥n</button>
          </div>
        </div>
      </div>

      <!-- LIST -->
      <div style="display:flex;flex-direction:column;gap:10px;" id="automations-list">
        <div class="empty-state" style="padding:40px;">No hay automatizaciones todav√≠a.</div>
      </div>

    </div>
  </div>


</div>

<!-- ======== CALENDAR ======== -->
<div class="section" id="section-calendar">
  <div class="calendar-layout">
    <div class="cal-sidebar">
      <div class="cal-mini">
        <div class="cal-mini-header">
          <button class="cal-mini-nav" onclick="miniCalPrev()">‚Äπ</button>
          <div class="cal-mini-title" id="mini-cal-title">‚Äî</div>
          <button class="cal-mini-nav" onclick="miniCalNext()">‚Ä∫</button>
        </div>
        <div class="cal-mini-grid" id="mini-cal-grid"></div>
      </div>
      <div class="card habit-tracker-card">
        <div class="card-header"><span class="dot" style="background:var(--green)"></span> H√°bitos de Hoy</div>
        <div style="padding:8px 16px;" id="cal-habits-today"></div>
        <div class="empty-state" id="cal-habits-empty">No hay h√°bitos creados a√∫n</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="dot"></span> Leyenda</div>
        <div style="padding:10px 16px;display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);"><span style="width:12px;height:12px;border-radius:3px;background:rgba(200,16,46,0.4);border-left:3px solid var(--accent);display:inline-block;flex-shrink:0;"></span> Misi√≥n Diaria</div>
          <div style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);"><span style="width:12px;height:12px;border-radius:3px;background:rgba(160,80,220,0.35);border-left:3px solid #b060f0;display:inline-block;flex-shrink:0;"></span> Side Quest</div>
          <div style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);"><span style="width:12px;height:12px;border-radius:3px;background:rgba(64,200,128,0.3);border-left:3px solid var(--green);display:inline-block;flex-shrink:0;"></span> H√°bito</div>
          <div style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);"><span style="width:12px;height:12px;border-radius:3px;background:rgba(212,160,23,0.3);border-left:3px solid var(--gold);display:inline-block;flex-shrink:0;"></span> Objetivo</div>
          <div style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);"><span style="width:12px;height:12px;border-radius:3px;background:rgba(64,80,160,0.35);border-left:3px solid var(--blue);display:inline-block;flex-shrink:0;"></span> Bloque libre</div>
        </div>
      </div>
    </div>
    <div class="cal-main">
      <div class="cal-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <button class="cal-mini-nav" style="font-size:18px;" onclick="calNav(-1)">‚Äπ</button>
          <div class="cal-date-title" id="cal-main-title">‚Äî</div>
          <button class="cal-mini-nav" style="font-size:18px;" onclick="calNav(1)">‚Ä∫</button>
          <button class="btn-secondary" style="padding:4px 10px;font-size:11px;margin-left:6px;" onclick="calGoToday()">Hoy</button>
        </div>
        <div class="cal-view-btns">
          <button class="cal-view-btn active" id="cal-btn-day" onclick="setCalView('day',this)">D√≠a</button>
          <button class="cal-view-btn" id="cal-btn-week" onclick="setCalView('week',this)">Semana</button>
        </div>
      </div>
      <div id="cal-body" style="flex:1;overflow:hidden;display:flex;flex-direction:column;"></div>
    </div>
  </div>
</div>

<!-- BLOCK MODAL -->
<div class="modal-overlay" id="block-modal">
  <div class="modal" style="width:400px;">
    <div class="modal-header">
      <div class="modal-title">Bloque de Tiempo Libre</div>
      <button class="modal-close" onclick="closeBlockModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre</label>
        <input class="form-input" id="block-name" placeholder="Ej: Lectura, Descanso, Paseo...">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Hora inicio</label>
          <input class="form-input" type="time" id="block-start-time">
        </div>
        <div class="form-group">
          <label class="form-label">Hora fin</label>
          <input class="form-input" type="time" id="block-end-time">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Color</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;" id="block-color-picker"></div>
      </div>
      <input type="hidden" id="block-date">
      <input type="hidden" id="block-edit-id">
      <div class="btn-row">
        <button class="btn-secondary" onclick="closeBlockModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveBlock()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- QUEST MODAL -->
<div class="modal-overlay" id="quest-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-quest-title">Nueva Misi√≥n</div>
      <button class="modal-close" onclick="closeQuestModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre</label>
        <input class="form-input" id="q-name" placeholder="¬øQu√© vas a conquistar?">
      </div>
      <div class="form-group">
        <label class="form-label">Tipo</label>
        <select class="form-select" id="q-type" onchange="updateQuestType()">
          <option value="daily">Misi√≥n Diaria</option>
          <option value="sidequest">Side Quest üéÆ</option>
          <option value="habit">H√°bito</option>
          <option value="objective">Objetivo</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Prioridad</label>
          <select class="form-select" id="q-prio" onchange="calcXP()">
            <option value="SSS">SSS ‚Äî Cr√≠tica</option>
            <option value="A">A ‚Äî Alta</option>
            <option value="B" selected>B ‚Äî Media</option>
            <option value="C">C ‚Äî Baja</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Dificultad</label>
          <select class="form-select" id="q-diff" onchange="calcXP()">
            <option value="hard">Dif√≠cil</option>
            <option value="medium" selected>Media</option>
            <option value="easy">F√°cil</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fecha inicio</label>
          <input class="form-input" type="date" id="q-start">
        </div>
        <div class="form-group">
          <label class="form-label">Fecha fin</label>
          <input class="form-input" type="date" id="q-end">
        </div>
      </div>
      <div class="form-row" id="q-time-row">
        <div class="form-group">
          <label class="form-label">Hora inicio</label>
          <input class="form-input" type="time" id="q-time-start" value="09:00">
        </div>
        <div class="form-group">
          <label class="form-label">Hora fin</label>
          <input class="form-input" type="time" id="q-time-end" value="10:00">
        </div>
      </div>
      <!-- Habit-specific: frequency -->
      <div class="form-group" id="q-freq-row" style="display:none;">
        <label class="form-label">Frecuencia</label>
        <select class="form-select" id="q-freq">
          <option value="daily">Todos los d√≠as</option>
          <option value="weekdays">D√≠as laborables (L‚ÄìV)</option>
          <option value="weekends">Fines de semana</option>
          <option value="custom">Personalizado</option>
        </select>
      </div>
      <div class="form-group" id="q-freq-days-row" style="display:none;">
        <label class="form-label">D√≠as</label>
        <div style="display:flex;gap:6px;">
          <label style="display:flex;flex-direction:column;align-items:center;gap:3px;font-size:10px;color:var(--text2);cursor:pointer;">
            <input type="checkbox" class="freq-day" value="1"> L
          </label>
          <label style="display:flex;flex-direction:column;align-items:center;gap:3px;font-size:10px;color:var(--text2);cursor:pointer;">
            <input type="checkbox" class="freq-day" value="2"> M
          </label>
          <label style="display:flex;flex-direction:column;align-items:center;gap:3px;font-size:10px;color:var(--text2);cursor:pointer;">
            <input type="checkbox" class="freq-day" value="3"> X
          </label>
          <label style="display:flex;flex-direction:column;align-items:center;gap:3px;font-size:10px;color:var(--text2);cursor:pointer;">
            <input type="checkbox" class="freq-day" value="4"> J
          </label>
          <label style="display:flex;flex-direction:column;align-items:center;gap:3px;font-size:10px;color:var(--text2);cursor:pointer;">
            <input type="checkbox" class="freq-day" value="5"> V
          </label>
          <label style="display:flex;flex-direction:column;align-items:center;gap:3px;font-size:10px;color:var(--text2);cursor:pointer;">
            <input type="checkbox" class="freq-day" value="6"> S
          </label>
          <label style="display:flex;flex-direction:column;align-items:center;gap:3px;font-size:10px;color:var(--text2);cursor:pointer;">
            <input type="checkbox" class="freq-day" value="0"> D
          </label>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Estad√≠stica relacionada</label>
        <select class="form-select" id="q-stat">
          <!-- filled by JS -->
        </select>
      </div>
      <div class="form-group" style="display:flex;align-items:center;gap:10px;">
        <label class="auto-day-label" style="width:auto;padding:6px 12px;display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="q-penalty-enabled" style="display:inline;width:auto;margin:0;">
          <span style="font-size:12px;color:var(--text2);">‚ö†Ô∏è Activar penalizaci√≥n por incumplimiento</span>
        </label>
      </div>
      <div class="xp-preview">
        <span class="xp-preview-label">XP a ganar</span>
        <span class="xp-preview-val" id="xp-preview-val">50 XP</span>
      </div>
      <div class="btn-row">
        <button class="btn-secondary" onclick="closeQuestModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveQuest()">Crear</button>
      </div>
    </div>
  </div>
</div>

<!-- NAME EDIT MODAL -->
<div class="modal-overlay" id="name-modal">
  <div class="modal" style="width:360px;">
    <div class="modal-header">
      <div class="modal-title">Editar Nombre</div>
      <button class="modal-close" onclick="document.getElementById('name-modal').classList.remove('open')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Tu nombre</label>
        <input class="form-input" id="name-edit-input" placeholder="Nombre de la protagonista...">
      </div>
      <div class="btn-row">
        <button class="btn-secondary" onclick="document.getElementById('name-modal').classList.remove('open')">Cancelar</button>
        <button class="btn-primary" onclick="saveName()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let state = {
  name: 'Protagonista',
  title: 'Aprendiz del Sistema',
  // titles: { name, icon, unlockType: 'level'|'achievement'|'manual', unlockVal, unlocked }
  titles: [
    { name: 'Aprendiz del Sistema', icon: 'üìñ', color: '#9090a8', unlockType: 'manual',      unlockVal: null,       unlocked: true  },
    { name: 'La Imparable',         icon: '‚ö°', color: '#f0c040', unlockType: 'level',        unlockVal: 5,          unlocked: false },
    { name: 'Cazadora de Metas',    icon: 'üéØ', color: '#e8263d', unlockType: 'achievement',  unlockVal: '5_quests', unlocked: false },
    { name: 'Maestra del Enfoque',  icon: 'üîÆ', color: '#9060d0', unlockType: 'level',        unlockVal: 10,         unlocked: false },
    { name: 'Leyenda Viviente',     icon: 'üëë', color: '#d4a017', unlockType: 'level',        unlockVal: 25,         unlocked: false },
  ],
  portrait: null,
  level: 1,
  xp: 0,
  totalXP: 0,
  vitals: { energy: 7, focus: 6, mood: 8 },
  // stats: val = raw points accumulated. statLevel = floor(val/10)+1
  stats: [
    { name: 'F√≠sico',     val: 0, color: '#e040a0' },
    { name: 'Psique',     val: 0, color: '#9060d0' },
    { name: 'Intel',      val: 0, color: '#4080e0' },
    { name: 'Espiritual', val: 0, color: '#40c880' },
    { name: 'Core',       val: 0, color: '#d4a017' },
  ],
  arc: { name: '', mantras: [] },
  quests: [],
  habits: [],        // separate habit tracking: { questId, date, done }
  timeBlocks: [],    // free blocks: { id, date, name, startTime, endTime, color }
  kaizenEntries: [], // { id, date, summary, good, bad, improve, tasks:[{id,text,done}] }
  automations: [],   // { id, name, type:'task'|'habit'|'block', priority, difficulty, stat, startDate, endDate, startTime, endTime, weekDays:[0-6], color, lastRun }
  penalties: [],     // { id, questId, questName, type, date, xp, forgiven, reason }
  sideQuestStreak: 0,  // consecutive days with required side quests done
  sideQuestStreakDate: null, // last date streak was updated
  achievements: [
    { name: 'Primera Misi√≥n', icon: '‚öîÔ∏è', unlocked: false, key: 'first_quest' },
    { name: 'Rayo Veloz',     icon: '‚ö°', unlocked: false, key: '5_quests' },
    { name: 'Nivel 5',        icon: 'üåü', unlocked: false, key: 'level_5' },
    { name: 'Racha x7',       icon: 'üî•', unlocked: false, key: 'streak_7' },
    { name: 'Jefe Ca√≠do',     icon: 'üíÄ', unlocked: false, key: 'boss' },
    { name: 'Imparable',      icon: 'üëë', unlocked: false, key: 'level_10' },
  ],
  // RANKS stored in state so they're customizable
  ranks: [
    { label: 'C',  icon: '‚óà',  minLevel: 1  },
    { label: 'B',  icon: '‚óÜ',  minLevel: 5  },
    { label: 'A',  icon: '‚óà',  minLevel: 10 },
    { label: 'S',  icon: '‚òÖ',  minLevel: 15 },
    { label: 'SS', icon: '‚òÖ‚òÖ', minLevel: 25 },
  ],
};

const XP_PER_LEVEL = (lvl) => lvl * 100;

// helpers
function statLevel(val) { return Math.floor(val / 10) + 1; }
function statLevelProgress(val) { return val % 10; }

function getCurrentRank() {
  const sorted = [...state.ranks].sort((a,b) => b.minLevel - a.minLevel);
  return sorted.find(r => state.level >= r.minLevel) || state.ranks[0];
}

function getRankColor(label) {
  const l = label.toUpperCase();
  if (l.startsWith('SS') || l === 'S') return 'var(--accent2)';
  if (l === 'A') return 'var(--gold2)';
  if (l === 'B') return 'var(--blue)';
  return 'var(--text2)';
}

// ============================================================
// LOAD / SAVE
// ============================================================
function saveState() {
  localStorage.setItem('leveling_state', JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem('leveling_state');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      state = { ...state, ...parsed };

      // Migrate old titles format (array of strings ‚Üí array of objects)
      if (state.titles.length > 0 && typeof state.titles[0] === 'string') {
        state.titles = state.titles.map((t, i) => ({
          name: t,
          icon: 'üéñÔ∏è',
          unlockType: 'manual',
          unlockVal: null,
          unlocked: true,
        }));
      }

      // Ensure all title objects have required fields
      state.titles = state.titles.map(t => ({
        name: t.name || 'Sin nombre',
        icon: t.icon || 'üéñÔ∏è',
        color: t.color || '#e8263d',
        unlockType: t.unlockType || 'manual',
        unlockVal: t.unlockVal ?? null,
        unlocked: t.unlocked ?? true,
      }));

      // Ensure habits and timeBlocks arrays exist
      if (!state.habits) state.habits = [];
      if (!state.timeBlocks) state.timeBlocks = [];
      if (!state.kaizenEntries) state.kaizenEntries = [];
      if (!state.automations) state.automations = [];
      if (!state.penalties) state.penalties = [];
      if (state.sideQuestStreak === undefined) state.sideQuestStreak = 0;
      if (state.sideQuestStreakDate === undefined) state.sideQuestStreakDate = null;

      // Migrate quests missing time fields
      state.quests = state.quests.map(q => ({
        startTime: '', endTime: '', freq: null, customDays: null, ...q
      }));
      if (!state.ranks || state.ranks.length === 0) {
        state.ranks = [
          { label: 'C',  icon: '‚óà',  minLevel: 1  },
          { label: 'B',  icon: '‚óÜ',  minLevel: 5  },
          { label: 'A',  icon: '‚óà',  minLevel: 10 },
          { label: 'S',  icon: '‚òÖ',  minLevel: 15 },
          { label: 'SS', icon: '‚òÖ‚òÖ', minLevel: 25 },
        ];
      }

    } catch(e) { console.warn('Error loading state:', e); }
  }
}

// ============================================================
// INIT
// ============================================================
function init() {
  loadState();

  // Ensure state.title is always a valid unlocked title
  const validTitle = state.titles.find(t => t.name === state.title && t.unlocked);
  if (!validTitle) {
    const firstUnlocked = state.titles.find(t => t.unlocked);
    state.title = firstUnlocked ? firstUnlocked.name : state.titles[0]?.name || '';
  }

  // Run automations on load
  runAutomations();

  // Check for overdue tasks / missed side quests and apply penalties
  checkPenalties();

  const today = new Date().toISOString().split('T')[0];
  document.getElementById('q-start').value = today;
  document.getElementById('q-end').value = today;

  // Init automation date fields
  const autoStartEl = document.getElementById('auto-start-date');
  const autoEndEl   = document.getElementById('auto-end-date');
  if (autoStartEl) autoStartEl.value = today;
  if (autoEndEl)   autoEndEl.value   = today;

  renderAll();
}

function renderAll() {
  renderPlayer();
  renderVitals();
  renderStats();
  renderRadar('radar-svg');
  renderRadar('radar-svg2');
  renderTodayQuests();
  renderMissions();
  renderProfile();
  renderConfig();
  renderSummary();
  updateTopbar();
}

// ============================================================
// PLAYER RENDER
// ============================================================
function renderPlayer() {
  document.getElementById('player-name-text').textContent = state.name;
  document.getElementById('player-title-text').textContent = state.title;
  document.getElementById('profile-name-text').textContent = state.name;
  document.getElementById('profile-title-text').textContent = state.title;
  // Apply active title color
  const activeTitle = state.titles.find(t => t.name === state.title);
  const titleColor = activeTitle?.color || '#e8263d';
  document.getElementById('player-title-text').style.color = titleColor;
  document.getElementById('profile-title-text').style.color = titleColor;

  const lvlEl = document.getElementById('player-level-num');
  const lvlEl2 = document.getElementById('profile-level-num');
  if (lvlEl) lvlEl.textContent = state.level;
  if (lvlEl2) lvlEl2.textContent = state.level;

  const needed = XP_PER_LEVEL(state.level);
  const pct = Math.min(100, (state.xp / needed) * 100);

  document.getElementById('current-xp').textContent = state.xp;
  document.getElementById('next-xp').textContent = needed;
  document.getElementById('xp-bar-fill').style.width = pct + '%';

  document.getElementById('profile-current-xp').textContent = state.xp;
  document.getElementById('profile-next-xp').textContent = needed;
  document.getElementById('profile-xp-bar').style.width = pct + '%';

  // Arc
  document.getElementById('arc-name-text').textContent = state.arc.name || 'Sin arco activo';
  const mantrasEl = document.getElementById('arc-mantras');
  mantrasEl.innerHTML = state.arc.mantras.map(m =>
    `<div class="arc-mantra">‚Äî ${m}</div>`
  ).join('');

  // Portrait
  if (state.portrait) {
    showPortrait('portrait-img', 'portrait-placeholder', state.portrait);
    showPortrait('portrait-img2', 'portrait-placeholder2', state.portrait);
  }
}

function showPortrait(imgId, phId, src) {
  const img = document.getElementById(imgId);
  const ph = document.getElementById(phId);
  if (img && ph) {
    img.src = src; img.style.display = 'block';
    ph.style.display = 'none';
  }
}

// ============================================================
// VITALS
// ============================================================
function renderVitals() {
  renderVitalDots('energy-dots', 'energy-dot', state.vitals.energy, 'energy', 'energy-num');
  renderVitalDots('focus-dots', 'focus-dot', state.vitals.focus, 'focus', 'focus-num');
  renderVitalDots('mood-dots', 'mood-dot', state.vitals.mood, 'mood', 'mood-num');
}

function renderVitalDots(containerId, cls, val, type, numId) {
  const container = document.getElementById(containerId);
  if (!container) return;
  container.innerHTML = '';
  for (let i = 1; i <= 10; i++) {
    const d = document.createElement('div');
    d.className = `vital-dot ${cls} ${i <= val ? 'filled' : ''}`;
    d.onclick = () => { state.vitals[type] = i; renderVitals(); saveState(); };
    container.appendChild(d);
  }
  document.getElementById(numId).textContent = `${val}/10`;
}

// ============================================================
// STATS
// ============================================================
function renderStats() {
  const listEl = document.getElementById('stats-list-dash');
  if (!listEl) return;
  listEl.innerHTML = '';
  state.stats.forEach(s => {
    const lvl = statLevel(s.val);
    const prog = statLevelProgress(s.val); // 0-9
    const pct = (prog / 10) * 100;
    listEl.innerHTML += `
      <div class="stat-row">
        <span class="stat-name">${s.name}</span>
        <div class="stat-bar-wrap">
          <div class="stat-bar"><div class="stat-fill" style="width:${pct}%;background:linear-gradient(90deg,${s.color}88,${s.color})"></div></div>
        </div>
        <span class="stat-val" style="color:${s.color};width:44px;font-size:11px;">Nv.${lvl}</span>
      </div>`;
  });

  // Profile stats detail
  const detailEl = document.getElementById('profile-stats-detail');
  if (detailEl) {
    detailEl.innerHTML = state.stats.map(s => {
      const lvl = statLevel(s.val);
      const prog = statLevelProgress(s.val);
      return `
      <div class="stat-detail-item">
        <div class="stat-detail-name" style="color:${s.color}88;">${s.name}</div>
        <div class="stat-detail-val" style="color:${s.color};">Nv. ${lvl}</div>
        <div style="margin:6px 0 4px;">
          <div class="stat-bar" style="height:5px;"><div class="stat-fill" style="width:${(prog/10)*100}%;background:${s.color};"></div></div>
        </div>
        <div class="stat-detail-sub">${s.val} pts totales ¬∑ ${prog}/10 para nivel ${lvl+1}</div>
      </div>`;
    }).join('');
  }
}

// ============================================================
// RADAR CHART
// ============================================================
function renderRadar(svgId) {
  const svg = document.getElementById(svgId);
  if (!svg) return;

  const stats = state.stats.slice(0, 6);
  const n = stats.length;
  if (n < 3) { svg.innerHTML = '<text x="150" y="130" text-anchor="middle" fill="#555" font-size="12">A√±ade al menos 3 stats</text>'; return; }

  const cx = 150, cy = 135, maxR = 100;
  const maxVal = 100;
  const angleStep = (2 * Math.PI) / n;

  function pt(i, r) {
    const angle = -Math.PI / 2 + i * angleStep;
    return { x: cx + r * Math.cos(angle), y: cy + r * Math.sin(angle) };
  }

  let html = '';

  // Grid polygons
  for (let g = 1; g <= 5; g++) {
    const r = (maxR / 5) * g;
    const pts = Array.from({length: n}, (_, i) => pt(i, r));
    html += `<polygon class="radar-grid" points="${pts.map(p => `${p.x},${p.y}`).join(' ')}"/>`;
  }

  // Axes
  for (let i = 0; i < n; i++) {
    const p = pt(i, maxR);
    html += `<line class="radar-axis" x1="${cx}" y1="${cy}" x2="${p.x}" y2="${p.y}"/>`;
  }

  // Data polygon ‚Äî use stat level, cap at 20 for display
  const maxStatLvl = 20;
  const dataPts = stats.map((s, i) => {
    const lvl = statLevel(s.val);
    const r = (Math.min(lvl, maxStatLvl) / maxStatLvl) * maxR;
    return pt(i, r);
  });
  html += `<polygon class="radar-polygon" points="${dataPts.map(p => `${p.x},${p.y}`).join(' ')}"/>`;

  // Dots
  dataPts.forEach(p => {
    html += `<circle class="radar-dot" cx="${p.x}" cy="${p.y}" r="3"/>`;
  });

  // Labels
  for (let i = 0; i < n; i++) {
    const p = pt(i, maxR + 18);
    const anchor = p.x < cx - 5 ? 'end' : p.x > cx + 5 ? 'start' : 'middle';
    html += `<text class="radar-label" x="${p.x}" y="${p.y + 4}" text-anchor="${anchor}">${stats[i].name.toUpperCase()}</text>`;
  }

  svg.innerHTML = html;
}

// ============================================================
// TODAY QUESTS
// ============================================================
function renderTodayQuests() {
  const el = document.getElementById('today-quests-list');
  if (!el) return;
  const today = new Date().toISOString().split('T')[0];
  const todayDow = new Date().getDay();

  const todayQuests = state.quests.filter(q =>
    (q.type === 'daily' || q.type === 'sidequest') && q.start <= today && q.end >= today
  );

  const todayHabits = state.quests.filter(q => {
    if (q.type !== 'habit' || q.start > today || q.end < today) return false;
    if (q.freq === 'weekdays' && (todayDow === 0 || todayDow === 6)) return false;
    if (q.freq === 'weekends' && todayDow !== 0 && todayDow !== 6) return false;
    if (q.freq === 'custom' && q.customDays && !q.customDays.includes(todayDow)) return false;
    return true;
  });

  const all = [...todayQuests, ...todayHabits];

  // Pending penalties waiting for forgive/apply decision
  const pendingPenalties = state.penalties.filter(p => p.status === 'pending');

  let html = '';

  // Side quest status bar
  const todaySideQuests = todayQuests.filter(q => q.type === 'sidequest');
  const doneSideQuests  = todaySideQuests.filter(q => q.done && q.doneDate === today);
  const requiredSQ = Math.min(2, todaySideQuests.length > 0 ? 2 : 0);
  if (todaySideQuests.length > 0) {
    const sqDone = doneSideQuests.length;
    const sqOk   = sqDone >= requiredSQ;
    const streak = state.sideQuestStreak || 0;
    html += `
    <div style="background:rgba(160,80,220,0.08);border:1px solid rgba(160,80,220,0.25);border-radius:8px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;gap:12px;">
      <span style="font-size:20px;">üéÆ</span>
      <div style="flex:1;">
        <div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#c080ff;margin-bottom:3px;">Side Quests del d√≠a</div>
        <div style="font-size:12px;color:var(--text2);">${sqDone} / ${requiredSQ} completadas ${sqOk ? '<span style="color:var(--green);">‚úì</span>' : '<span style="color:var(--accent);">‚Äî obligatorio</span>'}</div>
      </div>
      ${streak > 0 ? `<div class="sq-streak-badge">üî• ${streak} d√≠as</div>` : ''}
    </div>`;
  }

  // Pending penalty alerts
  pendingPenalties.forEach(p => {
    const timeLeft = getPenaltyForgiveWindow(p);
    html += `
    <div class="penalty-banner">
      <span class="penalty-icon">‚ö†Ô∏è</span>
      <div class="penalty-text">
        <strong style="color:var(--accent);">${p.questName}</strong> no completada a tiempo<br>
        <span style="font-size:11px;color:var(--text3);">${p.date} ¬∑ plazo vencido</span>
        ${timeLeft > 0 ? `<span style="font-size:11px;color:var(--gold);"> ¬∑ ${timeLeft}h para decidir</span>` : ''}
      </div>
      <span class="penalty-xp">‚àí${p.xp} XP</span>
      <button class="penalty-forgive-btn" onclick="openForgiveModal('${p.id}')">‚öñÔ∏è Perdonar</button>
      <button class="btn-secondary" style="padding:3px 8px;font-size:11px;color:var(--accent);border-color:var(--accent);" onclick="applyPenalty('${p.id}')">Aplicar</button>
    </div>`;
  });

  if (all.length === 0 && pendingPenalties.length === 0) {
    el.innerHTML = html + '<div class="empty-state">No hay misiones para hoy. ¬°Crea una!</div>';
    return;
  }

  html += all.map(q => {
    const isHabit    = q.type === 'habit';
    const isSideQuest = q.type === 'sidequest';
    const done = isHabit
      ? state.habits.some(h => h.questId === q.id && h.date === today && h.done)
      : q.done && q.doneDate === today;

    // Check if this quest is currently overdue (time passed, not done yet)
    const nowTime     = new Date().toTimeString().slice(0, 5);
    const isOverdue   = !done && !isHabit && q.endTime && nowTime > q.endTime;
    const isLate      = q.lateCompletion; // completed after deadline

    const diffCls  = `diff-${q.difficulty}`;
    const prioCls  = `prio-${(q.priority||'b').toLowerCase()}`;
    const onclick  = isHabit ? `toggleHabitToday('${q.id}')` : `toggleQuest('${q.id}')`;
    const sqStyle  = isSideQuest ? 'border-left:2px solid #b060f0;' : '';
    const overdueStyle = isOverdue ? 'opacity:0.7;border-left:2px solid var(--accent);' : '';
    const sqBadge  = isSideQuest ? `<span style="font-size:10px;background:rgba(160,80,220,0.15);color:#c080ff;border:1px solid rgba(160,80,220,0.25);border-radius:3px;padding:1px 5px;">üéÆ SIDE</span>` : '';
    const overdueBadge = isOverdue ? `<span style="font-size:10px;background:rgba(200,16,46,0.15);color:var(--accent);border:1px solid rgba(200,16,46,0.3);border-radius:3px;padding:1px 5px;">‚è∞ VENCIDA</span>` : '';
    const lateBadge    = isLate    ? `<span style="font-size:10px;background:rgba(212,160,23,0.1);color:var(--gold);border:1px solid rgba(212,160,23,0.2);border-radius:3px;padding:1px 5px;">‚ö†Ô∏è Tarde</span>` : '';

    return `
    <div class="quest-item" style="${sqStyle}${overdueStyle}">
      <div class="quest-check ${done ? 'done' : ''}" onclick="${onclick}" ${isOverdue ? 'title="Completar fuera de plazo genera penalizaci√≥n"' : ''}>
        ${done ? '‚úì' : ''}
      </div>
      <div class="quest-info">
        <div class="quest-name ${done ? 'done-text' : ''}">${q.name}${isHabit ? ' üîÑ' : ''}</div>
        <div class="quest-tags">
          ${sqBadge}${overdueBadge}${lateBadge}
          <span class="tag ${prioCls}">${q.priority}</span>
          <span class="tag ${diffCls}">${q.difficulty}</span>
          ${q.stat ? `<span class="tag stat">+${q.stat}</span>` : ''}
          ${q.endTime ? `<span class="tag" style="color:${isOverdue ? 'var(--accent)' : 'var(--text3)'};border-color:${isOverdue ? 'rgba(200,16,46,0.3)' : 'var(--border)'};">üïê ${q.startTime ? q.startTime+'‚Äì' : ''}${q.endTime}</span>` : ''}
        </div>
      </div>
      <div class="quest-xp" style="${isOverdue||isLate ? 'color:var(--accent);' : ''}">${isLate ? '¬±0' : '+'+q.xp} XP</div>
    </div>`;
  }).join('');

  el.innerHTML = html;
}

function toggleQuest(id) {
  const q = state.quests.find(x => x.id === id);
  if (!q) return;
  if (q.done) return; // already done, nothing to do

  const now     = new Date();
  const today   = now.toISOString().split('T')[0];
  const nowTime = now.toTimeString().slice(0, 5); // 'HH:MM'

  // Check if deadline has passed
  const dateExpired = q.end < today;
  const timeExpired = q.end === today && q.endTime && nowTime > q.endTime;
  const isOverdue   = dateExpired || timeExpired;

  if (isOverdue) {
    // Create penalty immediately if not already registered
    const already = state.penalties.some(p => p.questId === q.id);
    if (!already) {
      const rate   = PENALTY_RATE[q.type] || 0.5;
      const xpLoss = Math.round((q.xp || 0) * rate);
      if (xpLoss > 0) {
        state.penalties.push({
          id:        'pen_' + q.id + '_' + q.end,
          questId:   q.id,
          questName: q.name,
          type:      q.type,
          date:      q.end,
          xp:        xpLoss,
          status:    'pending',
          reason:    '',
          createdAt: now.toISOString(),
        });
      }
    }
    // Mark as done but give NO XP ‚Äî penalizaci√≥n ya registrada
    q.done     = true;
    q.doneDate = today;
    q.lateCompletion = true;
    saveState();
    renderAll();
    showNotification('‚ö†Ô∏è', `"${q.name}" completada fuera de plazo ‚Äî penalizaci√≥n registrada`);
    return;
  }

  // ---- On time ----
  q.done     = true;
  q.doneDate = today;

  let xpGain = q.xp;
  if (q.type === 'sidequest') {
    const bonus = getSideQuestStreakBonus();
    if (bonus > 0) xpGain = Math.round(xpGain * (1 + bonus));
    showNotification('üéÆ', `+${xpGain} XP ‚Äî Side Quest completada${bonus > 0 ? ` (√ó${(1+bonus).toFixed(1)})` : ''}`);
  } else {
    showNotification('‚ö°', `+${xpGain} XP ‚Äî "${q.name}" completada`);
  }

  addXP(xpGain);
  if (q.stat) {
    const stat = state.stats.find(s => s.name === q.stat);
    if (stat) {
      const prev = statLevel(stat.val);
      stat.val += 1;
      if (statLevel(stat.val) > prev) showNotification('üìà', `¬°${stat.name} subi√≥ a nivel ${statLevel(stat.val)}!`);
    }
  }
  checkAchievements();
  saveState();
  renderAll();
}

// ============================================================
// XP & LEVEL
// ============================================================
function addXP(amount) {
  state.xp += amount;
  state.totalXP += amount;
  const needed = XP_PER_LEVEL(state.level);
  if (state.xp >= needed) {
    state.xp -= needed;
    state.level++;
    showLevelUp(state.level);
    checkAchievements();
  }
}

function showLevelUp(lvl) {
  document.getElementById('levelup-new-level').textContent = `NIVEL ${lvl}`;
  const overlay = document.getElementById('levelup-overlay');
  overlay.classList.add('show');
}

function closeLevelUp() {
  document.getElementById('levelup-overlay').classList.remove('show');
}

// ============================================================
// MISSIONS
// ============================================================
let currentMissionsTab = 'all';

function switchMissionsTab(tab, btn) {
  currentMissionsTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderMissions();
}

function renderMissions() {
  const container = document.getElementById('missions-list-container');
  if (!container) return;

  let quests = state.quests;
  if (currentMissionsTab === 'daily') quests = quests.filter(q => q.type === 'daily');
  else if (currentMissionsTab === 'sidequest') quests = quests.filter(q => q.type === 'sidequest');
  else if (currentMissionsTab === 'habit') quests = quests.filter(q => q.type === 'habit');
  else if (currentMissionsTab === 'objective') quests = quests.filter(q => q.type === 'objective');
  else if (currentMissionsTab === 'done') quests = quests.filter(q => q.done && q.type !== 'habit');
  else quests = quests.filter(q => !q.done || q.type === 'habit');

  if (quests.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:40px;">No hay nada aqu√≠ todav√≠a.</div>';
    return;
  }

  const today   = new Date().toISOString().split('T')[0];
  const nowTime = new Date().toTimeString().slice(0, 5);

  container.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px;">` +
    quests.map(q => {
      const diffCls = `diff-${q.difficulty}`;
      const prioCls = `prio-${q.priority.toLowerCase()}`;
      const isHabit = q.type === 'habit';
      const habitDoneToday = isHabit && state.habits.some(h => h.questId === q.id && h.date === today && h.done);
      const streak  = isHabit ? getHabitStreak(q.id) : 0;
      const typeLabel = isHabit ? 'H√°bito' : q.type === 'daily' ? 'Diaria' : q.type === 'sidequest' ? 'üéÆ Side Quest' : 'Objetivo';
      const timeStr = q.startTime ? `${q.startTime}‚Äì${q.endTime}` : '';

      // Overdue / late detection
      const dateExpired = !isHabit && q.end < today;
      const timeExpired = !isHabit && q.end === today && q.endTime && nowTime > q.endTime;
      const isOverdue   = !q.done && (dateExpired || timeExpired);
      const isLate      = q.lateCompletion;

      const cardBorder  = isOverdue ? 'border-color:rgba(200,16,46,0.4);' : isLate ? 'border-color:rgba(212,160,23,0.3);' : '';
      const xpDisplay   = isLate ? '¬±0 XP' : `${q.xp} XP`;
      const xpColor     = isOverdue || isLate ? 'color:var(--accent);' : '';

      const overdueBadge = isOverdue ? `<span class="tag" style="background:rgba(200,16,46,0.15);color:var(--accent);border-color:rgba(200,16,46,0.3);">‚è∞ VENCIDA</span>` : '';
      const lateBadge    = isLate    ? `<span class="tag" style="background:rgba(212,160,23,0.1);color:var(--gold);border-color:rgba(212,160,23,0.2);">‚ö†Ô∏è Tarde</span>` : '';

      const completeBtn = isOverdue
        ? `<button class="btn-secondary" style="padding:5px 12px;font-size:11px;color:var(--accent);border-color:rgba(200,16,46,0.4);" onclick="toggleQuest('${q.id}')" title="Completar fuera de plazo ‚Äî generar√° penalizaci√≥n">‚ö†Ô∏è Completar tarde</button>`
        : `<button class="btn-secondary" style="padding:5px 12px;font-size:11px;" onclick="toggleQuest('${q.id}')">Completar</button>`;

      return `
      <div class="mission-item" style="${cardBorder}">
        <div class="mission-header">
          <div>
            <div class="mission-name">${isHabit && habitDoneToday ? '‚úì ' : ''}${q.name}</div>
            ${timeStr ? `<div style="font-size:10px;color:${isOverdue ? 'var(--accent)' : 'var(--text3)'};font-family:'Share Tech Mono',monospace;margin-top:2px;">üïê ${timeStr}</div>` : ''}
          </div>
          <span class="mission-xp-reward" style="${xpColor}">${xpDisplay}</span>
        </div>
        <div class="mission-meta">
          <span class="tag ${prioCls}">Prio ${q.priority}</span>
          <span class="tag ${diffCls}">${q.difficulty}</span>
          <span class="tag" style="background:rgba(80,80,100,0.1);color:var(--text2);border:1px solid var(--border);">${typeLabel}</span>
          ${q.stat ? `<span class="tag stat">${q.stat}</span>` : ''}
          ${isHabit && streak > 0 ? `<span class="tag" style="background:rgba(212,160,23,0.1);color:var(--gold);border:1px solid rgba(212,160,23,0.2);">üî• ${streak} d√≠as</span>` : ''}
          ${overdueBadge}${lateBadge}
        </div>
        <div class="mission-dates">${q.start} ‚Üí ${q.end} ${isHabit && q.freq ? '¬∑ ' + freqLabel(q.freq) : ''}</div>
        <div class="mission-progress-wrap" style="margin-top:10px;">
          ${isHabit
            ? `<button class="btn-secondary" style="padding:5px 12px;font-size:11px;${habitDoneToday ? 'color:var(--green);border-color:var(--green);' : ''}" onclick="toggleHabitToday('${q.id}')">${habitDoneToday ? '‚úì Hecho hoy' : 'Marcar hoy'}</button>`
            : (!q.done
                ? completeBtn
                : `<span style="font-size:11px;color:${isLate ? 'var(--gold)' : 'var(--green)'};">${isLate ? '‚ö†Ô∏è Completada tarde' : '‚úì Completada'}</span>`)
          }
          <button class="remove-btn" onclick="deleteQuest('${q.id}')" style="margin-left:auto;">üóë</button>
        </div>
      </div>`;
    }).join('') + '</div>';
}

function freqLabel(freq) {
  return { daily: 'Diario', weekdays: 'L‚ÄìV', weekends: 'S‚ÄìD', custom: 'Custom' }[freq] || freq;
}

function deleteQuest(id) {
  if (!confirm('¬øEliminar?')) return;
  state.quests = state.quests.filter(q => q.id !== id);
  state.habits = state.habits.filter(h => h.questId !== id);
  saveState(); renderAll();
}

function toggleHabitToday(questId) {
  const today = new Date().toISOString().split('T')[0];
  const existing = state.habits.find(h => h.questId === questId && h.date === today);
  if (existing) {
    existing.done = !existing.done;
  } else {
    state.habits.push({ questId, date: today, done: true });
  }
  const q = state.quests.find(x => x.id === questId);
  const entry = state.habits.find(h => h.questId === questId && h.date === today);
  if (entry?.done && q) {
    addXP(q.xp);
    if (q.stat) {
      const stat = state.stats.find(s => s.name === q.stat);
      if (stat) {
        const prev = statLevel(stat.val);
        stat.val += 1;
        if (statLevel(stat.val) > prev) showNotification('üìà', `¬°${stat.name} subi√≥ a nivel ${statLevel(stat.val)}!`);
      }
    }
    showNotification('‚úÖ', `H√°bito completado: "${q.name}"`);
    checkAchievements();
  }
  saveState(); renderAll();
}

function getHabitStreak(questId) {
  const sorted = state.habits
    .filter(h => h.questId === questId && h.done)
    .map(h => h.date)
    .sort()
    .reverse();
  if (!sorted.length) return 0;
  let streak = 0;
  let d = new Date();
  for (let i = 0; i < 365; i++) {
    const ds = d.toISOString().split('T')[0];
    if (sorted.includes(ds)) { streak++; d.setDate(d.getDate() - 1); }
    else if (i === 0) { d.setDate(d.getDate() - 1); } // allow today to not be done yet
    else break;
  }
  return streak;
}

// ============================================================
// QUEST MODAL
// ============================================================
let questModalType = 'daily';

function openQuestModal(type) {
  questModalType = type || 'daily';
  document.getElementById('q-type').value = questModalType;
  const isHabit = questModalType === 'habit';
  document.getElementById('q-freq-row').style.display = isHabit ? 'flex' : 'none';
  document.getElementById('q-freq-days-row').style.display = 'none';
  document.getElementById('modal-quest-title').textContent =
    isHabit ? 'Nuevo H√°bito' :
    questModalType === 'objective' ? 'Nuevo Objetivo' :
    questModalType === 'sidequest' ? 'Nueva Side Quest üéÆ' : 'Nueva Misi√≥n Diaria';

  // Fill stat options
  const statSel = document.getElementById('q-stat');
  statSel.innerHTML = '<option value="">Sin estad√≠stica</option>' +
    state.stats.map(s => `<option>${s.name}</option>`).join('');

  calcXP();
  document.getElementById('quest-modal').classList.add('open');
}

function closeQuestModal() {
  document.getElementById('quest-modal').classList.remove('open');
  document.getElementById('q-name').value = '';
}

function updateQuestType() {
  questModalType = document.getElementById('q-type').value;
  const isHabit = questModalType === 'habit';
  document.getElementById('q-freq-row').style.display = isHabit ? 'flex' : 'none';
  document.getElementById('q-freq-days-row').style.display = 'none';
  document.getElementById('modal-quest-title').textContent =
    isHabit ? 'Nuevo H√°bito' :
    questModalType === 'objective' ? 'Nuevo Objetivo' :
    questModalType === 'sidequest' ? 'Nueva Side Quest üéÆ' : 'Nueva Misi√≥n Diaria';
}

document.getElementById('q-freq')?.addEventListener('change', function() {
  document.getElementById('q-freq-days-row').style.display =
    this.value === 'custom' ? 'flex' : 'none';
});

function calcXP() {
  const prio = document.getElementById('q-prio').value;
  const diff = document.getElementById('q-diff').value;
  const prioMult = { SSS: 3, A: 2, B: 1.5, C: 1 };
  const diffMult = { hard: 3, medium: 2, easy: 1 };
  const base = 20;
  const xp = Math.round(base * prioMult[prio] * diffMult[diff]);
  document.getElementById('xp-preview-val').textContent = xp + ' XP';
  return xp;
}

function saveQuest() {
  const name = document.getElementById('q-name').value.trim();
  if (!name) { alert('Ponle un nombre!'); return; }
  const xp = calcXP();
  const type = document.getElementById('q-type').value;
  const freq = type === 'habit' ? document.getElementById('q-freq').value : null;
  const customDays = type === 'habit' && freq === 'custom'
    ? [...document.querySelectorAll('.freq-day:checked')].map(c => parseInt(c.value))
    : null;

  const quest = {
    id: Date.now().toString(),
    name,
    type,
    priority: document.getElementById('q-prio').value,
    difficulty: document.getElementById('q-diff').value,
    start: document.getElementById('q-start').value,
    end: document.getElementById('q-end').value,
    startTime: document.getElementById('q-time-start').value,
    endTime: document.getElementById('q-time-end').value,
    stat: document.getElementById('q-stat').value,
    freq,
    customDays,
    xp,
    done: false,
    doneDate: null,
    penaltyEnabled: document.getElementById('q-penalty-enabled')?.checked || false,
  };
  state.quests.push(quest);
  saveState();
  closeQuestModal();
  renderAll();
  showNotification('üìã', `"${name}" creado`);
}

// ============================================================
// PROFILE
// ============================================================
function renderProfile() {
  // Achievements
  const grid = document.getElementById('achievements-grid');
  if (grid) {
    grid.innerHTML = state.achievements.map(a => `
      <div class="achievement ${a.unlocked ? '' : 'achievement-locked'}">
        <div class="achievement-icon">${a.icon}</div>
        <div class="achievement-name">${a.name}</div>
      </div>`).join('');
  }

  // Penalty history
  const penEl    = document.getElementById('penalty-history-list');
  const penEmpty = document.getElementById('penalty-history-empty');
  if (penEl) {
    const applied  = state.penalties.filter(p => p.status !== 'pending');
    if (applied.length > 0) {
      penEmpty && (penEmpty.style.display = 'none');
      penEl.innerHTML = applied.slice().reverse().slice(0, 20).map(p => {
        const icon   = p.status === 'forgiven' ? '‚öñÔ∏è' : 'üíÄ';
        const color  = p.status === 'forgiven' ? 'var(--gold)' : 'var(--accent)';
        const label  = p.status === 'forgiven' ? 'Perdonada' : 'Aplicada';
        const typeEmoji = { sidequest:'üéÆ', daily:'‚öîÔ∏è', habit:'üîÑ', objective:'üéØ' }[p.type] || '‚ö†Ô∏è';
        return `
        <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 14px;border-bottom:1px solid var(--border);">
          <span style="font-size:16px;flex-shrink:0;">${icon}</span>
          <div style="flex:1;">
            <div style="font-size:12px;color:var(--text);">${typeEmoji} ${p.questName}</div>
            <div style="font-size:10px;color:var(--text3);margin-top:2px;">${p.date} ¬∑ ${label}
              ${p.reason ? `¬∑ <em style="color:var(--gold);">${p.reason.slice(0,50)}${p.reason.length>50?'‚Ä¶':''}</em>` : ''}
            </div>
          </div>
          <span style="font-family:'Share Tech Mono',monospace;font-size:11px;color:${color};white-space:nowrap;">
            ${p.status === 'forgiven' ? '¬±0' : '‚àí'+p.xp} XP
          </span>
        </div>`;
      }).join('');
    } else {
      penEmpty && (penEmpty.style.display = 'block');
      penEl.innerHTML = '';
    }
  }

  // History
  const hist = state.quests.filter(q => q.done);
  const histEl = document.getElementById('history-list');
  const histEmpty = document.getElementById('history-empty');
  if (histEl) {
    if (hist.length > 0) {
      histEmpty && (histEmpty.style.display = 'none');
      histEl.innerHTML = hist.slice(-10).reverse().map(q => `
        <div class="quest-item">
          <span style="color:var(--green);font-size:12px;">‚úì</span>
          <div class="quest-info">
            <div class="quest-name" style="font-size:12px;">${q.name}</div>
            <div style="font-size:10px;color:var(--text3);">${q.doneDate || '‚Äî'}</div>
          </div>
          <span class="quest-xp">+${q.xp} XP</span>
        </div>`).join('');
    } else {
      histEmpty && (histEmpty.style.display = 'block');
      histEl.innerHTML = '';
    }
  }
}

// ============================================================
// ACHIEVEMENTS
// ============================================================
function checkAchievements() {
  const done = state.quests.filter(q => q.done).length;

  const unlock = (key) => {
    const a = state.achievements.find(x => x.key === key);
    if (a && !a.unlocked) {
      a.unlocked = true;
      showNotification('üèÜ', `Logro desbloqueado: ${a.name}`);
      // auto-unlock titles tied to this achievement
      state.titles.forEach(t => {
        if (t.unlockType === 'achievement' && t.unlockVal === key && !t.unlocked) {
          t.unlocked = true;
          showNotification('üéñÔ∏è', `T√≠tulo desbloqueado: "${t.name}"`);
        }
      });
    }
  };

  if (done >= 1) unlock('first_quest');
  if (done >= 5) unlock('5_quests');
  if (state.level >= 5)  unlock('level_5');
  if (state.level >= 10) unlock('level_10');

  // auto-unlock titles tied to level
  state.titles.forEach(t => {
    if (t.unlockType === 'level' && state.level >= t.unlockVal && !t.unlocked) {
      t.unlocked = true;
      showNotification('üéñÔ∏è', `T√≠tulo desbloqueado: "${t.name}"`);
    }
  });
}

// ============================================================
// SUMMARY
// ============================================================
function renderSummary() {
  const today = new Date().toISOString().split('T')[0];
  const completedToday = state.quests.filter(q => q.done && q.doneDate === today).length;
  document.getElementById('completed-today').textContent = completedToday;
  document.getElementById('total-missions-count').textContent = state.quests.length;
  document.getElementById('total-xp-earned').textContent = state.totalXP + ' XP';

  // Rank
  const rank = getCurrentRank();
  const rankEl = document.getElementById('rank-badge');
  if (rankEl) {
    rankEl.className = 'rank-badge';
    rankEl.style.color = getRankColor(rank.label);
    rankEl.textContent = `${rank.icon} ${rank.label}`;
  }
}

function updateTopbar() {
  document.getElementById('topbar-xp-val').textContent = state.totalXP + ' XP';
  document.getElementById('topbar-level').textContent = 'Nv. ' + state.level;
}

// ============================================================
// CONFIG
// ============================================================
function renderConfig() {
  document.getElementById('config-name').value = state.name;
  document.getElementById('config-arc-name').value = state.arc.name || '';
  document.getElementById('config-arc-mantras').value = state.arc.mantras.join('\n');

  // Titles select ‚Äî only unlocked ones
  const titleSel = document.getElementById('config-title');
  const unlocked = state.titles.filter(t => t.unlocked);
  titleSel.innerHTML = unlocked.map(t =>
    `<option value="${t.name}" ${t.name === state.title ? 'selected' : ''}>${t.icon} ${t.name}</option>`).join('');

  // Titles list with unlock conditions
  const titlesList = document.getElementById('titles-list');
  if (titlesList) {
    titlesList.innerHTML = state.titles.map((t, i) => {
      const unlockDesc = t.unlockType === 'manual' ? 'Manual'
        : t.unlockType === 'level' ? `Nivel ${t.unlockVal}`
        : `Logro: ${t.unlockVal}`;
      return `
      <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);">
        <span style="font-size:16px;">${t.icon}</span>
        <div style="flex:1;">
          <div style="font-size:13px;color:${t.unlocked ? (t.color || 'var(--text)') : 'var(--text3)'};">${t.name}</div>
          <div style="font-size:10px;color:var(--text3);letter-spacing:0.8px;">${unlockDesc} ¬∑ ${t.unlocked ? '‚úì Desbloqueado' : 'üîí Bloqueado'}</div>
        </div>
        ${t.unlocked ? `<input type="color" value="${t.color || '#e8263d'}" title="Color del t√≠tulo" style="width:24px;height:24px;border:none;background:none;cursor:pointer;border-radius:4px;padding:0;" onchange="updateTitleColor(${i},this.value)">` : '<div style="width:24px;"></div>'}
        ${i > 0 ? `<button class="remove-btn" onclick="removeTitle(${i})">‚úï</button>` : '<div style="width:28px;"></div>'}
      </div>`;
    }).join('');
  }

  // Stats config
  const statsCfg = document.getElementById('stats-config-list');
  if (statsCfg) {
    statsCfg.innerHTML = state.stats.map((s, i) => `
      <div class="stat-config-item">
        <input type="color" value="${s.color}" style="width:28px;height:28px;border:none;background:none;cursor:pointer;border-radius:4px;" onchange="updateStatColor(${i},this.value)">
        <input class="form-input" value="${s.name}" style="flex:1;" onchange="updateStatName(${i},this.value)">
        <span style="font-size:11px;color:var(--text2);white-space:nowrap;">Nv.${statLevel(s.val)} (${s.val}pts)</span>
        <button class="remove-btn" onclick="removeStat(${i})">‚úï</button>
      </div>`).join('');
  }

  // Ranks config ‚Äî editable
  const ranksEl = document.getElementById('ranks-display');
  if (ranksEl) {
    ranksEl.innerHTML = state.ranks.map((r, i) => `
      <div style="display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid var(--border);">
        <input class="form-input" value="${r.icon}" style="width:44px;text-align:center;" onchange="updateRank(${i},'icon',this.value)" placeholder="‚óà">
        <input class="form-input" value="${r.label}" style="width:60px;" onchange="updateRank(${i},'label',this.value)" placeholder="A">
        <span style="font-size:11px;color:var(--text3);">desde Nv.</span>
        <input class="form-input" type="number" value="${r.minLevel}" style="width:56px;" onchange="updateRank(${i},'minLevel',+this.value)" min="1">
        ${i > 0 ? `<button class="remove-btn" onclick="removeRank(${i})">‚úï</button>` : '<div style="width:28px;"></div>'}
      </div>`).join('') + `
      <button class="btn-secondary" style="margin-top:8px;width:100%;" onclick="addRank()">+ A√±adir rango</button>`;
  }

  // Automations list
  renderAutomationsList();
}

function updateNameFromConfig() {
  state.name = document.getElementById('config-name').value;
  saveState(); renderPlayer();
}

function updateTitleFromConfig() {
  const val = document.getElementById('config-title').value;
  if (val) {
    state.title = val;
    saveState();
    renderPlayer();
  }
}

function updateArc() {
  state.arc.name = document.getElementById('config-arc-name').value;
  state.arc.mantras = document.getElementById('config-arc-mantras').value
    .split('\n').map(l => l.trim()).filter(Boolean);
  saveState(); renderPlayer();
}

function toggleTitleUnlockInput() {
  const type = document.getElementById('new-title-unlock-type').value;
  const valInput = document.getElementById('new-title-unlock-val');
  valInput.style.display = type === 'manual' ? 'none' : 'block';
  valInput.placeholder = type === 'level' ? 'Nv. ej: 10' : 'Clave logro';
}

function addTitle() {
  const name = document.getElementById('new-title-input').value.trim();
  if (!name) return;
  const icon = document.getElementById('new-title-icon').value.trim() || 'üéñÔ∏è';
  const color = document.getElementById('new-title-color').value || '#e8263d';
  const unlockType = document.getElementById('new-title-unlock-type').value;
  const rawVal = document.getElementById('new-title-unlock-val').value.trim();
  const unlockVal = unlockType === 'level' ? (parseInt(rawVal) || 1) : (rawVal || null);
  const unlocked = unlockType === 'manual';
  state.titles.push({ name, icon, color, unlockType, unlockVal, unlocked });
  document.getElementById('new-title-input').value = '';
  document.getElementById('new-title-icon').value = '';
  document.getElementById('new-title-unlock-val').value = '';
  saveState(); renderConfig();
}

function updateTitleColor(i, color) {
  state.titles[i].color = color;
  saveState();
  renderPlayer(); // update displayed title color immediately
  renderConfig();
}

function removeTitle(i) {
  state.titles.splice(i, 1);
  // If active title was removed, fallback to first unlocked
  if (!state.titles.find(t => t.name === state.title)) {
    state.title = state.titles.find(t => t.unlocked)?.name || '';
  }
  saveState(); renderConfig(); renderPlayer();
}

function addRank() {
  const maxLvl = Math.max(...state.ranks.map(r => r.minLevel));
  state.ranks.push({ label: 'NEW', icon: '‚óá', minLevel: maxLvl + 5 });
  saveState(); renderConfig();
}

function removeRank(i) {
  state.ranks.splice(i, 1);
  saveState(); renderConfig(); renderSummary();
}

function updateRank(i, field, val) {
  state.ranks[i][field] = val;
  saveState(); renderSummary();
}

function addStat() {
  const val = document.getElementById('new-stat-name').value.trim();
  if (!val) return;
  state.stats.push({ name: val, val: 0, color: '#e040a0' });
  document.getElementById('new-stat-name').value = '';
  saveState(); renderAll();
}

function removeStat(i) {
  state.stats.splice(i, 1);
  saveState(); renderAll();
}

function updateStatColor(i, val) {
  state.stats[i].color = val;
  saveState(); renderAll();
}

function updateStatName(i, val) {
  state.stats[i].name = val;
  saveState(); renderAll();
}

function updateStatVal(i, val) {
  state.stats[i].val = parseInt(val) || 0;
  saveState(); renderAll();
}

// ============================================================
// PORTRAIT
// ============================================================
function triggerPortraitUpload(inputId) {
  document.getElementById(inputId).click();
}

function handlePortraitChange(input, imgId, phId) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    state.portrait = e.target.result;
    showPortrait(imgId, phId, state.portrait);
    // Sync both portraits
    showPortrait('portrait-img', 'portrait-placeholder', state.portrait);
    showPortrait('portrait-img2', 'portrait-placeholder2', state.portrait);
    saveState();
  };
  reader.readAsDataURL(file);
}

// ============================================================
// NAME EDIT
// ============================================================
function editName() {
  document.getElementById('name-edit-input').value = state.name;
  document.getElementById('name-modal').classList.add('open');
}

function saveName() {
  const val = document.getElementById('name-edit-input').value.trim();
  if (val) { state.name = val; saveState(); renderPlayer(); }
  document.getElementById('name-modal').classList.remove('open');
}

// ============================================================
// NOTIFICATION
// ============================================================
function showNotification(icon, text) {
  const el = document.getElementById('notification');
  document.getElementById('notification-icon').textContent = icon;
  document.getElementById('notification-text').textContent = text;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 3000);
}

// ============================================================
// CALENDAR
// ============================================================
let calView = 'day';
let calDate = new Date();
let miniCalDate = new Date();
let blockColor = '#304080';
let calDragStart = null;

const BLOCK_COLORS = ['#304080','#4050a0','#a04080','#208060','#806020','#603080'];
const MONTH_NAMES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DAY_SHORT = ['D','L','M','X','J','V','S'];

function setCalView(view, btn) {
  calView = view;
  document.querySelectorAll('.cal-view-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderCalendar();
}

function calNav(dir) {
  if (calView === 'day') calDate.setDate(calDate.getDate() + dir);
  else calDate.setDate(calDate.getDate() + dir * 7);
  renderCalendar();
}

function calGoToday() {
  calDate = new Date();
  renderCalendar();
}

function miniCalPrev() { miniCalDate.setMonth(miniCalDate.getMonth() - 1); renderMiniCal(); }
function miniCalNext() { miniCalDate.setMonth(miniCalDate.getMonth() + 1); renderMiniCal(); }

function renderCalendar() {
  renderMiniCal();
  renderCalMain();
  renderCalHabits();
}

function renderMiniCal() {
  const el = document.getElementById('mini-cal-title');
  const grid = document.getElementById('mini-cal-grid');
  if (!el || !grid) return;

  el.textContent = `${MONTH_NAMES[miniCalDate.getMonth()]} ${miniCalDate.getFullYear()}`;

  const today = new Date().toISOString().split('T')[0];
  const selDate = calDate.toISOString().split('T')[0];

  // Day labels
  let html = DAY_SHORT.map(d => `<div class="cal-mini-day-label">${d}</div>`).join('');

  const first = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth(), 1);
  const startPad = first.getDay(); // 0=Sun
  const daysInMonth = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth() + 1, 0).getDate();
  const prevDays = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth(), 0).getDate();

  // Prev month padding
  for (let i = startPad - 1; i >= 0; i--) {
    html += `<div class="cal-mini-day other-month">${prevDays - i}</div>`;
  }

  // Days
  for (let d = 1; d <= daysInMonth; d++) {
    const ds = `${miniCalDate.getFullYear()}-${String(miniCalDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const hasEvents = getEventsForDate(ds).length > 0;
    const cls = [
      'cal-mini-day',
      ds === today ? 'today' : '',
      ds === selDate ? 'selected' : '',
      hasEvents ? 'has-events' : '',
    ].filter(Boolean).join(' ');
    html += `<div class="${cls}" onclick="calGoDate('${ds}')">${d}</div>`;
  }

  grid.innerHTML = html;
}

function calGoDate(ds) {
  calDate = new Date(ds + 'T12:00:00');
  renderCalendar();
}

function renderCalMain() {
  const body = document.getElementById('cal-body');
  const title = document.getElementById('cal-main-title');
  if (!body || !title) return;

  if (calView === 'day') {
    const ds = calDate.toISOString().split('T')[0];
    const opts = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
    title.textContent = calDate.toLocaleDateString('es-ES', opts);
    body.innerHTML = '';
    body.appendChild(buildDayView(ds));
  } else {
    // week
    const monday = getMonday(calDate);
    const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
    const fmtOpts = { month:'short', day:'numeric' };
    title.textContent = `${monday.toLocaleDateString('es-ES', fmtOpts)} ‚Äì ${sunday.toLocaleDateString('es-ES', fmtOpts)} ${sunday.getFullYear()}`;
    body.innerHTML = '';
    body.appendChild(buildWeekView(monday));
  }
}

function getMonday(d) {
  const day = d.getDay();
  const diff = (day === 0 ? -6 : 1 - day);
  const m = new Date(d);
  m.setDate(d.getDate() + diff);
  return m;
}

function buildDayView(dateStr) {
  const wrap = document.createElement('div');
  wrap.className = 'cal-day-view';

  // Time column
  const timeCol = document.createElement('div');
  timeCol.className = 'cal-time-col';
  for (let h = 0; h < 24; h++) {
    const label = document.createElement('div');
    label.className = 'cal-time-label';
    label.textContent = `${String(h).padStart(2,'0')}:00`;
    timeCol.appendChild(label);
  }

  // Events column
  const eventsCol = document.createElement('div');
  eventsCol.className = 'cal-events-col';
  eventsCol.style.position = 'relative';

  // Hour rows
  for (let h = 0; h < 24; h++) {
    const row = document.createElement('div');
    row.className = 'cal-hour-row';
    const half = document.createElement('div');
    half.className = 'cal-half-line';
    row.appendChild(half);
    eventsCol.appendChild(row);
  }

  // Now line
  const nowLine = buildNowLine();
  if (nowLine && dateStr === new Date().toISOString().split('T')[0]) {
    eventsCol.appendChild(nowLine);
  }

  // Place events with overlap resolution
  placeEventsInContainer(eventsCol, getEventsForDate(dateStr));

  // Double-click to create block
  eventsCol.addEventListener('dblclick', (e) => {
    if (e.target.closest('.cal-event')) return;
    const rect = eventsCol.getBoundingClientRect();
    const y = e.clientY - rect.top + eventsCol.scrollTop;
    const totalMinutes = 24 * 60;
    const pxPerMin = totalMinutes / totalMinutes; // 1px = 1min (60px/hr)
    const minutes = Math.round(y / 15) * 15; // snap to 15min
    const h = Math.min(Math.floor(minutes / 60), 23);
    const m = minutes % 60;
    const startTime = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    const endH = Math.min(h + 1, 23);
    const endTime = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    openBlockModal(dateStr, startTime, endTime);
  });

  wrap.appendChild(timeCol);
  wrap.appendChild(eventsCol);

  // Sync scroll
  setTimeout(() => {
    const now = new Date();
    const scrollTo = (now.getHours() * 60 - 60) / (24 * 60) * (24 * 60);
    eventsCol.scrollTop = Math.max(0, scrollTo);
    timeCol.scrollTop = eventsCol.scrollTop;
  }, 50);

  eventsCol.addEventListener('scroll', () => { timeCol.scrollTop = eventsCol.scrollTop; });

  return wrap;
}

function buildWeekView(monday) {
  const wrap = document.createElement('div');
  wrap.className = 'cal-week-view';

  // Header row
  const header = document.createElement('div');
  header.className = 'cal-week-header';
  header.innerHTML = '<div></div>'; // empty corner
  const today = new Date().toISOString().split('T')[0];
  for (let i = 0; i < 7; i++) {
    const d = new Date(monday); d.setDate(monday.getDate() + i);
    const ds = d.toISOString().split('T')[0];
    const isToday = ds === today;
    header.innerHTML += `<div class="cal-week-day-header ${isToday ? 'today-col' : ''}">
      ${DAY_SHORT[(d.getDay())]} ${d.getDate()}
    </div>`;
  }
  wrap.appendChild(header);

  // Body
  const body = document.createElement('div');
  body.className = 'cal-week-body';

  // Time column
  const timeCol = document.createElement('div');
  timeCol.style.cssText = 'width:52px;flex-shrink:0;';
  for (let h = 0; h < 24; h++) {
    const l = document.createElement('div');
    l.className = 'cal-time-label';
    l.textContent = `${String(h).padStart(2,'0')}:00`;
    timeCol.appendChild(l);
  }
  body.appendChild(timeCol);

  for (let i = 0; i < 7; i++) {
    const d = new Date(monday); d.setDate(monday.getDate() + i);
    const ds = d.toISOString().split('T')[0];
    const col = document.createElement('div');
    col.className = 'cal-week-col';

    for (let h = 0; h < 24; h++) {
      const row = document.createElement('div');
      row.className = 'cal-hour-row';
      const half = document.createElement('div');
      half.className = 'cal-half-line';
      row.appendChild(half);
      col.appendChild(row);
    }

    // Now line
    if (ds === today) {
      const nl = buildNowLine();
      if (nl) col.appendChild(nl);
    }

    // Events with overlap resolution
    placeEventsInContainer(col, getEventsForDate(ds));

    col.addEventListener('dblclick', (e) => {
      if (e.target.closest('.cal-event')) return;
      const rect = col.getBoundingClientRect();
      const y = e.clientY - rect.top + body.scrollTop;
      const minutes = Math.round(y / 15) * 15;
      const h = Math.min(Math.floor(minutes / 60), 23);
      const m = minutes % 60;
      const startTime = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      const endH = Math.min(h + 1, 23);
      const endTime = `${String(endH).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
      openBlockModal(ds, startTime, endTime);
    });

    body.appendChild(col);
  }

  // Sync scroll on body
  setTimeout(() => {
    const now = new Date();
    body.scrollTop = Math.max(0, (now.getHours() - 1) * 60);
  }, 50);

  wrap.appendChild(body);
  return wrap;
}

function buildNowLine() {
  const now = new Date();
  const pct = (now.getHours() * 60 + now.getMinutes()) / (24 * 60);
  const top = pct * 24 * 60;
  const line = document.createElement('div');
  line.className = 'cal-now-line';
  line.style.top = top + 'px';
  const dot = document.createElement('div');
  dot.className = 'cal-now-dot';
  line.appendChild(dot);
  return line;
}

function timeToMinutes(t) {
  if (!t) return 0;
  const [h, m] = t.split(':').map(Number);
  return h * 60 + m;
}

function buildEventEl(ev, leftPct, widthPct) {
  const startM  = timeToMinutes(ev.startTime);
  const endM    = timeToMinutes(ev.endTime);
  if (endM <= startM) return null;

  const top    = startM;
  const height = Math.max(endM - startM, 18);

  const el = document.createElement('div');
  el.className = `cal-event type-${ev.type}`;
  el.style.top    = top + 'px';
  el.style.height = height + 'px';
  el.style.left   = leftPct.toFixed(2) + '%';
  el.style.width  = widthPct.toFixed(2) + '%';
  el.style.right  = 'unset';

  if (ev.type === 'block') {
    el.style.background  = ev.color ? ev.color + '44' : 'rgba(64,80,160,0.35)';
    el.style.borderColor = ev.color || 'var(--blue)';
  }

  const done = ev.done || false;
  const opacity = done ? 'opacity:0.5;' : '';

  // Google Calendar style: name + time inline, small font for short blocks
  const isShort = height < 32;
  if (isShort) {
    el.innerHTML = `<div class="cal-event-title" style="${opacity}white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
      ${ev.name}<span class="cal-event-time" style="margin-left:4px;">${ev.startTime}</span>
    </div>`;
  } else {
    el.innerHTML = `<div class="cal-event-title" style="${opacity}">${ev.name}, <span class="cal-event-time">${ev.startTime}</span></div>
      ${height >= 48 ? `<div class="cal-event-time" style="margin-top:1px;">${ev.startTime} ‚Äì ${ev.endTime}</div>` : ''}`;
  }

  if (ev.type === 'block') {
    el.addEventListener('dblclick', e => { e.stopPropagation(); openBlockModal(ev.date, ev.startTime, ev.endTime, ev); });
  } else {
    el.addEventListener('click', () => {
      if (ev.type === 'habit') toggleHabitToday(ev.id);
      else if (!ev.done) toggleQuest(ev.id);
    });
  }
  return el;
}

// -------------------------------------------------------
// Google Calendar layout algorithm
// Groups overlapping events, assigns columns within each group,
// then calculates exact left% and width% per event.
// -------------------------------------------------------
function layoutEvents(events) {
  if (!events.length) return [];

  const sorted = [...events].sort((a, b) => {
    const diff = timeToMinutes(a.startTime) - timeToMinutes(b.startTime);
    return diff !== 0 ? diff : timeToMinutes(b.endTime) - timeToMinutes(a.endTime);
  });

  // Step 1: find overlap groups (clusters)
  const groups = [];
  let group = [sorted[0]];
  let groupEnd = timeToMinutes(sorted[0].endTime);

  for (let i = 1; i < sorted.length; i++) {
    const ev = sorted[i];
    if (timeToMinutes(ev.startTime) < groupEnd) {
      group.push(ev);
      groupEnd = Math.max(groupEnd, timeToMinutes(ev.endTime));
    } else {
      groups.push(group);
      group = [ev];
      groupEnd = timeToMinutes(ev.endTime);
    }
  }
  groups.push(group);

  const result = [];

  for (const grp of groups) {
    // Step 2: assign columns within the group (greedy)
    const cols = []; // cols[c] = end minute of last event in col c
    const colAssign = grp.map(ev => {
      const startM = timeToMinutes(ev.startTime);
      let placed = -1;
      for (let c = 0; c < cols.length; c++) {
        if (cols[c] <= startM) { placed = c; break; }
      }
      if (placed === -1) { placed = cols.length; cols.push(0); }
      cols[placed] = timeToMinutes(ev.endTime);
      return placed;
    });

    const numCols = cols.length;

    // Step 3: compute width/left like Google Calendar
    // Each event spans from its column to the next column that conflicts,
    // or to the end if nothing conflicts. Simple version: equal width.
    grp.forEach((ev, i) => {
      const col    = colAssign[i];
      const left   = (col / numCols) * 100;
      // Try to expand right if no sibling starts in next col during this event
      // For simplicity and correctness, use equal columns (Google's default)
      const width  = (1 / numCols) * 100 - 0.5;
      result.push({ ev, leftPct: left + 0.25, widthPct: width });
    });
  }

  return result;
}

function placeEventsInContainer(container, events) {
  const laid = layoutEvents(events);
  laid.forEach(({ ev, leftPct, widthPct }) => {
    const el = buildEventEl(ev, leftPct, widthPct);
    if (el) container.appendChild(el);
  });
}

function getEventsForDate(dateStr) {
  const events = [];
  const d = new Date(dateStr + 'T12:00:00');
  const dayOfWeek = d.getDay(); // 0=Sun

  // Quests and habits active on this date
  state.quests.forEach(q => {
    if (q.start > dateStr || q.end < dateStr) return;
    if (!q.startTime || !q.endTime) return;

    // Apply frequency/day filters for all quest types
    if (q.freq === 'weekdays' && (dayOfWeek === 0 || dayOfWeek === 6)) return;
    if (q.freq === 'weekends' && dayOfWeek !== 0 && dayOfWeek !== 6) return;
    if (q.freq === 'custom' && q.customDays && !q.customDays.includes(dayOfWeek)) return;

    if (q.type === 'habit') {
      events.push({ ...q, type: 'habit', date: dateStr });
    } else {
      events.push({ ...q, date: dateStr });
    }
  });

  // Free blocks
  state.timeBlocks
    .filter(b => b.date === dateStr)
    .forEach(b => events.push({ ...b, type: 'block' }));

  return events;
}

function renderCalHabits() {
  const el = document.getElementById('cal-habits-today');
  const empty = document.getElementById('cal-habits-empty');
  if (!el) return;

  const today = new Date().toISOString().split('T')[0];
  const todayDow = new Date().getDay();
  const habits = state.quests.filter(q => {
    if (q.type !== 'habit') return false;
    if (q.start > today || q.end < today) return false;
    if (q.freq === 'weekdays' && (todayDow === 0 || todayDow === 6)) return false;
    if (q.freq === 'weekends' && todayDow !== 0 && todayDow !== 6) return false;
    if (q.freq === 'custom' && q.customDays && !q.customDays.includes(todayDow)) return false;
    return true;
  });

  if (habits.length === 0) {
    el.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';

  el.innerHTML = habits.map(h => {
    const done = state.habits.some(x => x.questId === h.id && x.date === today && x.done);
    const streak = getHabitStreak(h.id);
    return `<div class="habit-day-row">
      <div class="habit-check-dot ${done ? 'done' : ''}" onclick="toggleHabitToday('${h.id}')"></div>
      <span class="habit-name">${h.name}</span>
      ${streak > 0 ? `<span class="habit-streak">üî•${streak}</span>` : ''}
    </div>`;
  }).join('');
}

// Block modal
function openBlockModal(date, startTime, endTime, existingBlock) {
  document.getElementById('block-name').value = existingBlock?.name || '';
  document.getElementById('block-start-time').value = startTime || '09:00';
  document.getElementById('block-end-time').value = endTime || '10:00';
  document.getElementById('block-date').value = date;
  document.getElementById('block-edit-id').value = existingBlock?.id || '';
  blockColor = existingBlock?.color || '#304080';

  const picker = document.getElementById('block-color-picker');
  picker.innerHTML = BLOCK_COLORS.map(c =>
    `<div class="block-color-opt ${c === blockColor ? 'selected' : ''}" style="background:${c};" onclick="selectBlockColor('${c}',this)"></div>`
  ).join('');

  document.getElementById('block-modal').classList.add('open');
}

function closeBlockModal() {
  document.getElementById('block-modal').classList.remove('open');
}

function selectBlockColor(color, el) {
  blockColor = color;
  document.querySelectorAll('.block-color-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
}

function saveBlock() {
  const name = document.getElementById('block-name').value.trim();
  if (!name) { alert('Ponle un nombre al bloque'); return; }
  const editId = document.getElementById('block-edit-id').value;
  const block = {
    id: editId || Date.now().toString(),
    name,
    date: document.getElementById('block-date').value,
    startTime: document.getElementById('block-start-time').value,
    endTime: document.getElementById('block-end-time').value,
    color: blockColor,
  };
  if (editId) {
    const i = state.timeBlocks.findIndex(b => b.id === editId);
    if (i >= 0) state.timeBlocks[i] = block;
  } else {
    state.timeBlocks.push(block);
  }
  saveState();
  closeBlockModal();
  renderCalendar();
}

// ============================================================
// NAVIGATION
// ============================================================
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('section-' + id).classList.add('active');
  const btns = document.querySelectorAll('.nav-btn');
  const sections = ['dashboard', 'profile', 'missions', 'calendar', 'evals', 'config'];
  const idx = sections.indexOf(id);
  if (idx >= 0) btns[idx].classList.add('active');

  if (id === 'missions') renderMissions();
  if (id === 'profile') renderProfile();
  if (id === 'config') renderConfig();
  if (id === 'calendar') renderCalendar();
  if (id === 'evals') renderEvals();
}

// ============================================================
// EVALUACIONES
// ============================================================
let evalPeriod = 'day';

function setEvalPeriod(period, btn) {
  evalPeriod = period;
  document.querySelectorAll('.eval-period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderEvals();
}

function getDateRange() {
  const now = new Date();
  const today = now.toISOString().split('T')[0];

  if (evalPeriod === 'day') {
    return { start: today, end: today, label: 'hoy' };
  } else if (evalPeriod === 'week') {
    const mon = new Date(now);
    const day = now.getDay();
    mon.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    return { start: mon.toISOString().split('T')[0], end: sun.toISOString().split('T')[0], label: 'esta semana' };
  } else {
    const first = new Date(now.getFullYear(), now.getMonth(), 1);
    const last  = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    return { start: first.toISOString().split('T')[0], end: last.toISOString().split('T')[0], label: 'este mes' };
  }
}

function renderEvals() {
  renderEvalMetrics();
  renderKaizenHistory();
  renderKaizenPendingTasks();

  // Init date picker to today if empty
  const picker = document.getElementById('kaizen-date-picker');
  if (picker && !picker.value) {
    picker.value = new Date().toISOString().split('T')[0];
    loadKaizenForDate();
  }
}

function renderEvalMetrics() {
  const grid = document.getElementById('eval-metrics-grid');
  if (!grid) return;

  const range = getDateRange();
  const { start, end } = range;

  // Filter quests completed in range
  const completedQuests = state.quests.filter(q =>
    q.type !== 'habit' && q.done && q.doneDate >= start && q.doneDate <= end
  );

  // Habits completed in range
  const completedHabits = state.habits.filter(h =>
    h.done && h.date >= start && h.date <= end
  );

  // XP earned in range (approximation from completed tasks)
  const xpEarned = completedQuests.reduce((s, q) => s + (q.xp || 0), 0)
    + completedHabits.reduce((s, h) => {
      const q = state.quests.find(x => x.id === h.questId);
      return s + (q?.xp || 0);
    }, 0);

  // Total tasks in range
  const totalTasksInRange = state.quests.filter(q =>
    q.type !== 'habit' && q.start <= end && q.end >= start
  ).length;

  const completionRate = totalTasksInRange > 0
    ? Math.round((completedQuests.length / totalTasksInRange) * 100)
    : 0;

  // Streak: consecutive days with at least 1 completion
  const streak = calcCurrentStreak();

  // SSS tasks done
  const sssCount = completedQuests.filter(q => q.priority === 'SSS').length;

  // Best stat
  const statScores = state.stats.map(s => ({ name: s.name, lvl: statLevel(s.val) }));
  const bestStat = statScores.sort((a,b) => b.lvl - a.lvl)[0];

  // Performance score 0-100
  const perfScore = Math.min(100, Math.round(
    completionRate * 0.4 +
    Math.min(streak * 5, 30) +
    Math.min(sssCount * 10, 20) +
    Math.min(completedHabits.length * 2, 10)
  ));

  const scoreColor = perfScore >= 80 ? 'var(--green)' : perfScore >= 50 ? 'var(--gold)' : 'var(--accent)';
  const scoreGrade = perfScore >= 90 ? 'S' : perfScore >= 75 ? 'A' : perfScore >= 55 ? 'B' : perfScore >= 35 ? 'C' : 'D';

  grid.innerHTML = `
    <div class="eval-metric accent" style="grid-column:span 2;display:flex;align-items:center;gap:20px;">
      <div>
        <div style="font-family:'Share Tech Mono',monospace;font-size:52px;font-weight:700;color:${scoreColor};line-height:1;">${scoreGrade}</div>
        <div style="font-size:10px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--text3);">Rendimiento ${range.label}</div>
      </div>
      <div style="flex:1;">
        <div style="height:8px;background:var(--surface3);border-radius:4px;overflow:hidden;margin-bottom:8px;">
          <div style="height:100%;width:${perfScore}%;background:${scoreColor};border-radius:4px;transition:width 0.8s;"></div>
        </div>
        <div style="font-size:12px;color:var(--text2);">${perfScore} / 100 puntos de rendimiento</div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px;">
          ${completionRate}% completado ¬∑ ${completedQuests.length + completedHabits.length} acciones ¬∑ ${xpEarned} XP ganados
        </div>
      </div>
    </div>
    <div class="eval-metric green">
      <div class="eval-metric-val">${completedQuests.length}</div>
      <div class="eval-metric-label">Misiones completadas</div>
      <div class="eval-metric-sub">de ${totalTasksInRange} en el per√≠odo</div>
    </div>
    <div class="eval-metric gold">
      <div class="eval-metric-val">${completedHabits.length}</div>
      <div class="eval-metric-label">H√°bitos completados</div>
      <div class="eval-metric-sub">${range.label}</div>
    </div>
    <div class="eval-metric blue">
      <div class="eval-metric-val">${streak}</div>
      <div class="eval-metric-label">Racha actual</div>
      <div class="eval-metric-sub">d√≠as consecutivos</div>
    </div>
    <div class="eval-metric purple">
      <div class="eval-metric-val">${sssCount}</div>
      <div class="eval-metric-label">Misiones SSS</div>
      <div class="eval-metric-sub">prioridad cr√≠tica completadas</div>
    </div>
  `;

  // Stat bars
  const barsEl = document.getElementById('eval-stat-bars');
  if (barsEl) {
    const maxLvl = Math.max(...state.stats.map(s => statLevel(s.val)), 1);
    barsEl.innerHTML = state.stats.map(s => {
      const lvl = statLevel(s.val);
      const pct = (lvl / Math.max(maxLvl, 1)) * 100;
      return `<div class="bar-row">
        <span class="bar-label">${s.name}</span>
        <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${s.color};"></div></div>
        <span class="bar-val" style="color:${s.color};">Nv.${lvl}</span>
      </div>`;
    }).join('');
  }
}

function calcCurrentStreak() {
  const today = new Date().toISOString().split('T')[0];
  let streak = 0;
  let d = new Date();
  while (true) {
    const ds = d.toISOString().split('T')[0];
    const hasActivity =
      state.quests.some(q => q.done && q.doneDate === ds) ||
      state.habits.some(h => h.done && h.date === ds);
    if (!hasActivity) break;
    streak++;
    d.setDate(d.getDate() - 1);
    if (streak > 365) break;
  }
  return streak;
}

// ============================================================
// KAIZEN
// ============================================================
let kaizenCurrentTasks = []; // tasks for the currently open form
let kaizenEditingId = null;

function loadKaizenForDate() {
  const picker = document.getElementById('kaizen-date-picker');
  if (!picker) return;
  const date = picker.value;
  const label = document.getElementById('kaizen-form-date-label');
  const today = new Date().toISOString().split('T')[0];

  if (label) {
    label.textContent = date === today ? 'Reflexi√≥n de hoy' : `Reflexi√≥n del ${date}`;
  }

  const entry = state.kaizenEntries.find(e => e.date === date);
  if (entry) {
    kaizenEditingId = entry.id;
    kaizenCurrentTasks = JSON.parse(JSON.stringify(entry.tasks || []));
    document.getElementById('k-summary').value = entry.summary || '';
    document.getElementById('k-good').value    = entry.good    || '';
    document.getElementById('k-bad').value     = entry.bad     || '';
    document.getElementById('k-improve').value = entry.improve || '';
    const delBtn = document.getElementById('k-delete-btn');
    if (delBtn) delBtn.style.display = 'inline-flex';
  } else {
    kaizenEditingId = null;
    kaizenCurrentTasks = [];
    document.getElementById('k-summary').value = '';
    document.getElementById('k-good').value    = '';
    document.getElementById('k-bad').value     = '';
    document.getElementById('k-improve').value = '';
    const delBtn = document.getElementById('k-delete-btn');
    if (delBtn) delBtn.style.display = 'none';
  }
  renderKaizenTasks();
}

function newKaizenEntry() {
  const today = new Date().toISOString().split('T')[0];
  const picker = document.getElementById('kaizen-date-picker');
  if (picker) picker.value = today;
  loadKaizenForDate();
}

function addKaizenTask() {
  const input = document.getElementById('k-task-input');
  const text = input.value.trim();
  if (!text) return;
  kaizenCurrentTasks.push({ id: Date.now().toString(), text, done: false });
  input.value = '';
  renderKaizenTasks();
}

function toggleKaizenTask(taskId) {
  const t = kaizenCurrentTasks.find(x => x.id === taskId);
  if (t) t.done = !t.done;
  renderKaizenTasks();
}

function removeKaizenTask(taskId) {
  kaizenCurrentTasks = kaizenCurrentTasks.filter(x => x.id !== taskId);
  renderKaizenTasks();
}

function renderKaizenTasks() {
  const el = document.getElementById('k-tasks-list');
  if (!el) return;
  if (kaizenCurrentTasks.length === 0) {
    el.innerHTML = '<div style="font-size:12px;color:var(--text3);padding:4px 0;font-style:italic;">Sin tareas de mejora a√∫n...</div>';
    return;
  }
  el.innerHTML = kaizenCurrentTasks.map(t => `
    <div class="kaizen-task-item">
      <div class="kaizen-task-check ${t.done ? 'done' : ''}" onclick="toggleKaizenTask('${t.id}')">${t.done ? '‚úì' : ''}</div>
      <span class="kaizen-task-name ${t.done ? 'done-text' : ''}">${t.text}</span>
      <button class="remove-btn" onclick="removeKaizenTask('${t.id}')" style="width:22px;height:22px;font-size:11px;">‚úï</button>
    </div>`).join('');
}

function saveKaizenEntry() {
  const picker = document.getElementById('kaizen-date-picker');
  const date = picker?.value || new Date().toISOString().split('T')[0];

  const entry = {
    id: kaizenEditingId || Date.now().toString(),
    date,
    summary: document.getElementById('k-summary').value.trim(),
    good:    document.getElementById('k-good').value.trim(),
    bad:     document.getElementById('k-bad').value.trim(),
    improve: document.getElementById('k-improve').value.trim(),
    tasks:   JSON.parse(JSON.stringify(kaizenCurrentTasks)),
    savedAt: new Date().toISOString(),
  };

  if (kaizenEditingId) {
    const idx = state.kaizenEntries.findIndex(e => e.id === kaizenEditingId);
    if (idx >= 0) state.kaizenEntries[idx] = entry;
    else state.kaizenEntries.push(entry);
  } else {
    // Check if there's already an entry for this date
    const existing = state.kaizenEntries.findIndex(e => e.date === date);
    if (existing >= 0) state.kaizenEntries[existing] = { ...entry, id: state.kaizenEntries[existing].id };
    else state.kaizenEntries.push(entry);
    kaizenEditingId = entry.id;
  }

  saveState();
  renderKaizenHistory();
  renderKaizenPendingTasks();
  showNotification('‚ôæ', 'Reflexi√≥n Kaizen guardada');
  document.getElementById('k-delete-btn').style.display = 'inline-flex';
}

function deleteKaizenEntry() {
  if (!kaizenEditingId) return;
  if (!confirm('¬øEliminar esta reflexi√≥n?')) return;
  state.kaizenEntries = state.kaizenEntries.filter(e => e.id !== kaizenEditingId);
  saveState();
  newKaizenEntry();
  renderKaizenHistory();
  renderKaizenPendingTasks();
  showNotification('üóë', 'Reflexi√≥n eliminada');
}

function renderKaizenHistory() {
  const el = document.getElementById('kaizen-history');
  const empty = document.getElementById('kaizen-history-empty');
  if (!el) return;

  const sorted = [...state.kaizenEntries].sort((a,b) => b.date.localeCompare(a.date));

  if (sorted.length === 0) {
    el.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';

  el.innerHTML = sorted.map(e => {
    const pendingTasks = (e.tasks || []).filter(t => !t.done).length;
    const doneTasks    = (e.tasks || []).filter(t => t.done).length;
    return `
    <div class="kaizen-log-item" onclick="loadKaizenById('${e.id}')" style="cursor:pointer;">
      <div class="kaizen-log-date">
        <span>${e.date}</span>
        <div style="display:flex;gap:6px;">
          ${doneTasks > 0 ? `<span style="font-size:10px;color:var(--green);">‚úì${doneTasks}</span>` : ''}
          ${pendingTasks > 0 ? `<span style="font-size:10px;color:var(--purple);">‚ö°${pendingTasks}</span>` : ''}
        </div>
      </div>
      ${e.summary ? `<div class="kaizen-log-section">
        <div class="kaizen-log-section-title">Resumen</div>
        <div class="kaizen-log-text">${e.summary.length > 100 ? e.summary.slice(0,100) + '‚Ä¶' : e.summary}</div>
      </div>` : ''}
      ${e.improve ? `<div class="kaizen-log-section">
        <div class="kaizen-log-section-title">üî∫ Mejorar</div>
        <div class="kaizen-log-text">${e.improve.length > 80 ? e.improve.slice(0,80) + '‚Ä¶' : e.improve}</div>
      </div>` : ''}
    </div>`;
  }).join('');
}

function loadKaizenById(id) {
  const entry = state.kaizenEntries.find(e => e.id === id);
  if (!entry) return;
  const picker = document.getElementById('kaizen-date-picker');
  if (picker) picker.value = entry.date;
  loadKaizenForDate();
  // scroll form into view
  document.getElementById('k-summary')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderKaizenPendingTasks() {
  const el = document.getElementById('kaizen-pending-tasks');
  const empty = document.getElementById('kaizen-pending-empty');
  if (!el) return;

  // Collect all pending tasks across all entries
  const pending = [];
  state.kaizenEntries.forEach(entry => {
    (entry.tasks || []).forEach(t => {
      if (!t.done) pending.push({ ...t, entryDate: entry.date, entryId: entry.id });
    });
  });

  if (pending.length === 0) {
    el.innerHTML = '';
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';

  el.innerHTML = pending.map(t => `
    <div class="kaizen-task-item">
      <div class="kaizen-task-check" onclick="togglePendingTask('${t.entryId}','${t.id}')"></div>
      <div style="flex:1;">
        <span class="kaizen-task-name">${t.text}</span>
        <div style="font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;">${t.entryDate}</div>
      </div>
    </div>`).join('');
}

function togglePendingTask(entryId, taskId) {
  const entry = state.kaizenEntries.find(e => e.id === entryId);
  if (!entry) return;
  const task = (entry.tasks || []).find(t => t.id === taskId);
  if (task) {
    task.done = true;
    saveState();
    renderKaizenPendingTasks();
    renderKaizenHistory();
    // If this entry is currently open, refresh tasks too
    if (kaizenEditingId === entryId) {
      kaizenCurrentTasks = JSON.parse(JSON.stringify(entry.tasks));
      renderKaizenTasks();
    }
    showNotification('‚ö°', 'Tarea de mejora completada');
  }
}


// ============================================================
// AUTOMATIONS
// ============================================================
const DAY_LABELS = ['D','L','M','X','J','V','S'];
let autoBlockColor = '#304080';

let editingAutoId = null; // null = create mode, string = edit mode

function updateAutoType() {
  const type = document.getElementById('auto-type').value;
  document.getElementById('auto-task-fields').style.display  = type === 'block' ? 'none' : 'block';
  document.getElementById('auto-block-fields').style.display = type === 'block' ? 'block' : 'none';
}

function initAutoBlockColorPicker() {
  const picker = document.getElementById('auto-block-color-picker');
  if (!picker) return;
  picker.innerHTML = BLOCK_COLORS.map(c =>
    `<div class="block-color-opt ${c === autoBlockColor ? 'selected' : ''}"
      style="background:${c};" onclick="autoBlockColor='${c}';document.querySelectorAll('#auto-block-color-picker .block-color-opt').forEach(el=>el.classList.remove('selected'));this.classList.add('selected');"></div>`
  ).join('');
}

function getSelectedAutoDays() {
  return Array.from(document.querySelectorAll('.auto-day:checked')).map(cb => parseInt(cb.value));
}

function editAutomation(id) {
  const auto = state.automations.find(a => a.id === id);
  if (!auto) return;
  editingAutoId = id;

  document.getElementById('auto-name').value      = auto.name;
  document.getElementById('auto-type').value      = auto.type;
  document.getElementById('auto-start-date').value = auto.startDate;
  document.getElementById('auto-end-date').value   = auto.endDate;
  document.getElementById('auto-start-time').value = auto.startTime;
  document.getElementById('auto-end-time').value   = auto.endTime;

  if (auto.type !== 'block') {
    document.getElementById('auto-priority').value  = auto.priority  || 'B';
    document.getElementById('auto-difficulty').value = auto.difficulty || 'medium';
    const statSel = document.getElementById('auto-stat');
    if (statSel) statSel.value = auto.stat || '';
  } else {
    autoBlockColor = auto.color || '#304080';
    initAutoBlockColorPicker();
  }

  // Set day checkboxes
  document.querySelectorAll('.auto-day').forEach(cb => {
    cb.checked = auto.weekDays.includes(parseInt(cb.value));
  });

  updateAutoType();

  // Update button labels
  const saveBtn   = document.getElementById('auto-save-btn');
  const cancelBtn = document.getElementById('auto-cancel-btn');
  if (saveBtn)   saveBtn.textContent = 'üíæ Guardar cambios';
  if (cancelBtn) cancelBtn.style.display = 'block';

  // Scroll form into view
  document.getElementById('auto-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function flashSaveBtn(success) {
  const btn = document.getElementById('auto-save-btn');
  if (!btn) return;
  btn.textContent = success ? '‚úÖ ¬°Guardado!' : '‚ùå Revisa los campos';
  btn.style.background = success ? '#40c880' : '#c8102e';
  btn.style.borderColor = success ? '#40c880' : '#c8102e';
  btn.disabled = true;
  setTimeout(() => {
    btn.textContent = editingAutoId ? 'üíæ Guardar cambios' : '‚ö° Crear Automatizaci√≥n';
    btn.style.background = '';
    btn.style.borderColor = '';
    btn.disabled = false;
  }, 2000);
}

function cancelAutoEdit() {
  editingAutoId = null;
  document.getElementById('auto-name').value = '';
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('auto-start-date').value = today;
  document.getElementById('auto-end-date').value   = today;
  document.getElementById('auto-start-time').value = '09:00';
  document.getElementById('auto-end-time').value   = '10:00';
  document.querySelectorAll('.auto-day').forEach(cb => {
    const v = parseInt(cb.value);
    cb.checked = v >= 1 && v <= 5;
  });
  const saveBtn   = document.getElementById('auto-save-btn');
  const cancelBtn = document.getElementById('auto-cancel-btn');
  if (saveBtn)   { saveBtn.textContent = '‚ö° Crear Automatizaci√≥n'; saveBtn.style.background = ''; saveBtn.style.borderColor = ''; }
  if (cancelBtn) cancelBtn.style.display = 'none';
  renderAutomationsList();
}

function saveAutomation() {
  const name = document.getElementById('auto-name').value.trim();
  if (!name) { showNotification('‚ö†Ô∏è', 'Ponle un nombre'); flashSaveBtn(false); return; }

  const type      = document.getElementById('auto-type').value;
  const startDate = document.getElementById('auto-start-date').value;
  const endDate   = document.getElementById('auto-end-date').value;
  const startTime = document.getElementById('auto-start-time').value;
  const endTime   = document.getElementById('auto-end-time').value;
  const weekDays  = getSelectedAutoDays();

  if (!startDate || !endDate) { showNotification('‚ö†Ô∏è', 'Indica las fechas'); flashSaveBtn(false); return; }
  if (startDate > endDate)    { showNotification('‚ö†Ô∏è', 'Fecha inicio debe ser anterior al fin'); flashSaveBtn(false); return; }
  if (!startTime || !endTime) { showNotification('‚ö†Ô∏è', 'Indica la hora'); flashSaveBtn(false); return; }
  if (startTime >= endTime)   { showNotification('‚ö†Ô∏è', 'Hora inicio debe ser antes que fin'); flashSaveBtn(false); return; }
  if (weekDays.length === 0)  { showNotification('‚ö†Ô∏è', 'Selecciona al menos un d√≠a'); flashSaveBtn(false); return; }

  if (editingAutoId) {
    const auto = state.automations.find(a => a.id === editingAutoId);
    if (auto) {
      if (auto.type === 'block' && type !== 'block') {
        state.timeBlocks = state.timeBlocks.filter(b => b.autoId !== auto.id);
      } else if (auto.type !== 'block' && type === 'block') {
        state.habits = state.habits.filter(h => h.questId !== `auto_${auto.id}`);
        state.quests = state.quests.filter(q => q.id !== `auto_${auto.id}`);
      } else if (auto.type === 'block') {
        state.timeBlocks = state.timeBlocks.filter(b => b.autoId !== auto.id);
      }
      auto.name       = name;
      auto.type       = type;
      auto.priority   = document.getElementById('auto-priority')?.value  || 'B';
      auto.difficulty = document.getElementById('auto-difficulty')?.value || 'medium';
      auto.stat       = document.getElementById('auto-stat')?.value       || '';
      auto.color      = type === 'block' ? autoBlockColor : '';
      auto.startDate  = startDate;
      auto.endDate    = endDate;
      auto.startTime  = startTime;
      auto.endTime    = endTime;
      auto.weekDays   = weekDays;
      runSingleAutomation(auto);
      saveState();
      renderAutomationsList();
      renderAll();
      flashSaveBtn(true);
      showNotification('üíæ', `"${name}" actualizada`);
    }
    cancelAutoEdit();
  } else {
    const auto = {
      id: Date.now().toString(),
      name, type,
      priority:   document.getElementById('auto-priority')?.value  || 'B',
      difficulty: document.getElementById('auto-difficulty')?.value || 'medium',
      stat:       document.getElementById('auto-stat')?.value       || '',
      color:      type === 'block' ? autoBlockColor : '',
      startDate, endDate, startTime, endTime, weekDays,
      lastRun: null,
    };
    state.automations.push(auto);
    runSingleAutomation(auto);
    saveState();
    renderAutomationsList();
    renderAll();
    document.getElementById('auto-name').value = '';
    flashSaveBtn(true);
    const evCount = auto.type === 'block'
      ? state.timeBlocks.filter(b => b.autoId === auto.id).length + ' bloques en calendario'
      : 'quest activa en Misiones';
    showNotification('‚ö°', `"${name}" creada ‚Äî ${evCount}`);
  }
}

function deleteAutomation(id) {
  if (!confirm('¬øEliminar esta automatizaci√≥n?\nLos eventos ya creados tambi√©n se eliminar√°n.')) return;
  const auto = state.automations.find(a => a.id === id);
  if (auto) {
    if (auto.type === 'block') {
      state.timeBlocks = state.timeBlocks.filter(b => b.autoId !== id);
    } else {
      const questId = `auto_${id}`;
      // Also clean up habit log entries for this quest
      state.habits = state.habits.filter(h => h.questId !== questId);
      state.quests = state.quests.filter(q => q.id !== questId);
    }
  }
  state.automations = state.automations.filter(a => a.id !== id);
  saveState();
  renderAutomationsList();
  renderAll();
  showNotification('üóë', 'Automatizaci√≥n eliminada');
}

// Called on init ‚Äî ensures all automations are up-to-date
function runAutomations() {
  let anyChange = false;
  state.automations.forEach(auto => {
    if (runSingleAutomation(auto)) anyChange = true;
  });
  if (anyChange) saveState();
}

// Generates all missing events for a single automation. Returns true if anything was created.
function runSingleAutomation(auto) {
  let created = false;

  if (auto.type === 'block') {
    // Blocks: one entry per matching day across the full date range
    let cur = new Date(auto.startDate + 'T12:00:00');
    const end = new Date(auto.endDate + 'T12:00:00');

    while (cur <= end) {
      const ds  = cur.toISOString().split('T')[0];
      const dow = cur.getDay();
      if (auto.weekDays.includes(dow)) {
        const exists = state.timeBlocks.some(b => b.autoId === auto.id && b.date === ds);
        if (!exists) {
          state.timeBlocks.push({
            id:        `auto_${auto.id}_${ds}`,
            autoId:    auto.id,
            date:      ds,
            name:      auto.name,
            startTime: auto.startTime,
            endTime:   auto.endTime,
            color:     auto.color || '#304080',
          });
          created = true;
        }
      }
      cur.setDate(cur.getDate() + 1);
    }
  } else {
    // Tasks / habits: one quest spanning startDate‚ÜíendDate with customDays
    const questId = `auto_${auto.id}`;
    const existing = state.quests.find(q => q.id === questId);
    if (!existing) {
      const prioMult  = { SSS: 3, A: 2, B: 1.5, C: 1 };
      const diffMult  = { hard: 3, medium: 2, easy: 1 };
      const xp        = Math.round(20 * (prioMult[auto.priority] || 1.5) * (diffMult[auto.difficulty] || 2));
      const qType     = auto.type === 'habit' ? 'habit' : auto.type === 'sidequest' ? 'sidequest' : 'daily';

      state.quests.push({
        id:         questId,
        autoId:     auto.id,
        name:       auto.name,
        type:       qType,
        priority:   auto.priority,
        difficulty: auto.difficulty,
        stat:       auto.stat || '',
        startTime:  auto.startTime,
        endTime:    auto.endTime,
        start:      auto.startDate,
        end:        auto.endDate,
        freq:       'custom',
        customDays: auto.weekDays,
        xp,
        done:       false,
        doneDate:   null,
      });
      created = true;
    } else {
      // Update existing quest if automation parameters changed
      const qType = auto.type === 'habit' ? 'habit' : auto.type === 'sidequest' ? 'sidequest' : 'daily';
      const prioMult = { SSS: 3, A: 2, B: 1.5, C: 1 };
      const diffMult = { hard: 3, medium: 2, easy: 1 };
      const xp = Math.round(20 * (prioMult[auto.priority] || 1.5) * (diffMult[auto.difficulty] || 2));
      let changed = false;
      if (existing.end !== auto.endDate)         { existing.end = auto.endDate; changed = true; }
      if (existing.start !== auto.startDate)     { existing.start = auto.startDate; changed = true; }
      if (existing.name !== auto.name)           { existing.name = auto.name; changed = true; }
      if (existing.startTime !== auto.startTime) { existing.startTime = auto.startTime; changed = true; }
      if (existing.endTime !== auto.endTime)     { existing.endTime = auto.endTime; changed = true; }
      if (JSON.stringify(existing.customDays) !== JSON.stringify(auto.weekDays)) {
        existing.customDays = auto.weekDays; changed = true;
      }
      if (existing.priority !== auto.priority)   { existing.priority = auto.priority; existing.xp = xp; changed = true; }
      if (existing.difficulty !== auto.difficulty){ existing.difficulty = auto.difficulty; existing.xp = xp; changed = true; }
      if (existing.stat !== auto.stat)           { existing.stat = auto.stat; changed = true; }
      if (existing.type !== qType)               { existing.type = qType; changed = true; }
      if (changed) created = true;
    }
  }

  if (created) auto.lastRun = new Date().toISOString().split('T')[0];
  return created;
}

function renderAutomationsList() {
  const el = document.getElementById('automations-list');
  if (!el) return;

  // Refresh stat select in form
  const statSel = document.getElementById('auto-stat');
  if (statSel) {
    const cur = statSel.value;
    statSel.innerHTML = '<option value="">Sin estad√≠stica</option>' +
      state.stats.map(s => `<option value="${s.name}" ${s.name === cur ? 'selected' : ''}>${s.name}</option>`).join('');
  }
  initAutoBlockColorPicker();

  // Show/hide cancel button depending on edit mode
  // Sync cancel button visibility with edit mode
  const cancelBtn = document.getElementById('auto-cancel-btn');
  const saveBtn   = document.getElementById('auto-save-btn');
  if (cancelBtn) cancelBtn.style.display = editingAutoId ? 'block' : 'none';
  if (saveBtn && !saveBtn.disabled) {
    saveBtn.textContent = editingAutoId ? 'üíæ Guardar cambios' : '‚ö° Crear Automatizaci√≥n';
  }

  if (state.automations.length === 0) {
    el.innerHTML = '<div class="empty-state" style="padding:40px;">No hay automatizaciones todav√≠a.<br><span style="font-size:12px;color:var(--text3);">Crea una para que los eventos se generen solos.</span></div>';
    return;
  }

  const today = new Date().toISOString().split('T')[0];
  const DAY_DISPLAY = ['D','L','M','X','J','V','S'];

  el.innerHTML = state.automations.map(auto => {
    const typeLabelMap = { task: 'TAREA', habit: 'H√ÅBITO', block: 'BLOQUE', sidequest: 'SIDE QUEST' };
    const typeLabel    = typeLabelMap[auto.type] || auto.type.toUpperCase();
    const isActive     = auto.startDate <= today && auto.endDate >= today;
    const isEditing    = editingAutoId === auto.id;

    const blockCount = auto.type === 'block'
      ? state.timeBlocks.filter(b => b.autoId === auto.id).length : 0;
    const hasQuest = auto.type !== 'block' && state.quests.some(q => q.id === `auto_${auto.id}`);

    const countLabel = auto.type === 'block'
      ? `${blockCount} bloques`
      : hasQuest ? '‚úì Quest activa' : '‚Äî pendiente';

    return `
    <div class="automation-item ${isEditing ? 'editing' : ''}" style="${isEditing ? 'border-color:var(--gold);background:rgba(212,160,23,0.04);' : ''}">
      <div class="automation-item-header">
        <div class="automation-item-name">
          <span class="automation-type-badge ${auto.type}">${typeLabel}</span>
          ${auto.name}
          <span style="font-size:10px;margin-left:4px;${isActive ? 'color:var(--green);' : 'color:var(--text3);'}">‚óè ${isActive ? 'ACTIVA' : 'INACTIVA'}</span>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="btn-secondary" onclick="editAutomation('${auto.id}')" style="padding:3px 8px;font-size:11px;">‚úèÔ∏è Editar</button>
          <button class="remove-btn" onclick="deleteAutomation('${auto.id}')" title="Eliminar">üóë</button>
        </div>
      </div>
      <div class="automation-item-meta">
        <span>üìÖ ${auto.startDate} ‚Üí ${auto.endDate}</span>
        <span>üïê ${auto.startTime} ‚Äì ${auto.endTime}</span>
        ${auto.type !== 'block' ? `<span>Prio ${auto.priority} ¬∑ ${auto.difficulty}</span>` : ''}
        <span style="color:var(--text2);">${countLabel}</span>
      </div>
      <div class="automation-days">
        ${DAY_DISPLAY.map((d, i) => {
          const active = auto.weekDays.includes(i);
          return `<div class="auto-day-dot ${active ? 'active' : ''}">${d}</div>`;
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// PENALTY & SIDE QUEST SYSTEM
// ============================================================

// Streak bonus: +10% per day, capped at +100%
function getSideQuestStreakBonus() {
  const streak = state.sideQuestStreak || 0;
  return Math.min(streak * 0.10, 1.0);
}

// XP penalty multipliers per quest type
const PENALTY_RATE = {
  sidequest:  1.0,   // lose ALL the XP (full penalty)
  daily:      0.5,   // lose 50%
  habit:      0.3,   // lose 30%
  objective:  0.2,   // lose 20%
};

// Hours after deadline to allow forgiveness window
const FORGIVE_WINDOW_HOURS = 12;

function getPenaltyForgiveWindow(p) {
  const created = new Date(p.createdAt);
  const hoursLeft = Math.max(0, Math.round(
    (created.getTime() + FORGIVE_WINDOW_HOURS * 3600000 - Date.now()) / 3600000
  ));
  return hoursLeft;
}

// Called on app load ‚Äî only for quests that were NEVER completed (not even late)
function checkPenalties() {
  const now     = new Date();
  const today   = now.toISOString().split('T')[0];
  const nowTime = now.toTimeString().slice(0, 5);
  let changed   = false;

  // Check quests (daily, sidequest, objective) that are truly abandoned (not done at all)
  state.quests.forEach(q => {
    if (q.type === 'habit') return;
    if (q.done) return;  // done (even late) = toggleQuest already handled it

    // Has the deadline passed?
    const dateExpired = q.end < today;
    const timeExpired = q.end === today && q.endTime && nowTime > q.endTime;
    if (!dateExpired && !timeExpired) return;

    // No penalty already registered for this quest
    const already = state.penalties.some(p => p.questId === q.id);
    if (already) return;

    const rate   = PENALTY_RATE[q.type] || 0.5;
    const xpLoss = Math.round((q.xp || 0) * rate);
    if (xpLoss <= 0) return;

    state.penalties.push({
      id:        'pen_' + q.id + '_' + q.end,
      questId:   q.id,
      questName: q.name,
      type:      q.type,
      date:      q.end,
      xp:        xpLoss,
      status:    'pending',
      reason:    '',
      createdAt: now.toISOString(),
    });
    changed = true;
  });

  // Check habits (only those with penaltyEnabled) ‚Äî check yesterday's missed habits
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  const yd    = yesterday.toISOString().split('T')[0];
  const ydDow = yesterday.getDay();

  state.quests.filter(q => q.type === 'habit' && q.penaltyEnabled).forEach(q => {
    if (yd < q.start || yd > q.end) return;
    if (q.freq === 'weekdays' && (ydDow === 0 || ydDow === 6)) return;
    if (q.freq === 'weekends' && ydDow !== 0 && ydDow !== 6) return;
    if (q.freq === 'custom' && q.customDays && !q.customDays.includes(ydDow)) return;
    const done    = state.habits.some(h => h.questId === q.id && h.date === yd && h.done);
    if (done) return;
    const already = state.penalties.some(p => p.questId === q.id && p.date === yd);
    if (already) return;
    const xpLoss  = Math.round((q.xp || 0) * PENALTY_RATE.habit);
    if (xpLoss <= 0) return;
    state.penalties.push({
      id:        'pen_' + q.id + '_' + yd,
      questId:   q.id,
      questName: q.name,
      type:      'habit',
      date:      yd,
      xp:        xpLoss,
      status:    'pending',
      reason:    '',
      createdAt: now.toISOString(),
    });
    changed = true;
  });

  // Auto-apply expired pending penalties (forgive window passed)
  state.penalties.filter(p => p.status === 'pending').forEach(p => {
    if (getPenaltyForgiveWindow(p) === 0) {
      applyPenaltyById(p.id, false);
      changed = true;
    }
  });

  updateSideQuestStreak(today);
  if (changed) saveState();
}

function applyPenaltyById(penaltyId, notify) {
  const p = state.penalties.find(x => x.id === penaltyId);
  if (!p || p.status !== 'pending') return;
  p.status = 'applied';

  // Deduct XP (can go below 0 on current bar, level down if needed)
  state.xp -= p.xp;
  state.totalXP = Math.max(0, state.totalXP - p.xp);
  while (state.xp < 0 && state.level > 1) {
    state.level--;
    state.xp += XP_PER_LEVEL(state.level);
  }
  state.xp = Math.max(0, state.xp);

  if (notify !== false) {
    showNotification('üíÄ', '‚àí' + p.xp + ' XP ‚Äî penalizaci√≥n: "' + p.questName + '"');
  }
}

function applyPenalty(penaltyId) {
  applyPenaltyById(penaltyId, true);
  saveState();
  renderAll();
}

let forgiveTargetId = null;

function openForgiveModal(penaltyId) {
  forgiveTargetId = penaltyId;
  const p = state.penalties.find(x => x.id === penaltyId);
  if (!p) return;
  document.getElementById('forgive-quest-name').textContent = p.questName + ' ¬∑ ' + p.date;
  document.getElementById('forgive-xp-amount').textContent  = '‚àí' + p.xp + ' XP';
  document.getElementById('forgive-reason').value           = '';
  document.getElementById('forgive-modal').classList.add('open');
}

function closeForgiveModal() {
  document.getElementById('forgive-modal').classList.remove('open');
  forgiveTargetId = null;
}

function confirmForgive() {
  const p = state.penalties.find(x => x.id === forgiveTargetId);
  if (!p) return;
  const reason = document.getElementById('forgive-reason').value.trim();
  if (!reason) { showNotification('‚ö†Ô∏è', 'Escribe un motivo justificado'); return; }
  p.status = 'forgiven';
  p.reason = reason;
  saveState();
  closeForgiveModal();
  showNotification('‚öñÔ∏è', 'Perdonada ‚Äî "' + p.questName + '"');
  renderAll();
}

function updateSideQuestStreak(today) {
  if (state.sideQuestStreakDate === today) return;

  const d = new Date(today);
  d.setDate(d.getDate() - 1);
  const yesterday = d.toISOString().split('T')[0];

  const ydSQs = state.quests.filter(q =>
    q.type === 'sidequest' && q.start <= yesterday && q.end >= yesterday
  );
  if (ydSQs.length === 0) { state.sideQuestStreakDate = today; return; }

  const ydDone     = ydSQs.filter(q => q.done && q.doneDate === yesterday).length;
  const ydRequired = Math.min(2, ydSQs.length);

  if (ydDone >= ydRequired) {
    state.sideQuestStreak = (state.sideQuestStreak || 0) + 1;
    if (state.sideQuestStreak > 1) {
      const bonus = Math.round(getSideQuestStreakBonus() * 100);
      showNotification('üéÆ', 'Racha de Side Quests: ' + state.sideQuestStreak + ' d√≠as üî• (+' + bonus + '% XP)');
    }
  } else {
    if ((state.sideQuestStreak || 0) > 0) {
      showNotification('üíî', 'Racha de Side Quests rota (' + state.sideQuestStreak + ' d√≠as)');
    }
    state.sideQuestStreak = 0;
  }
  state.sideQuestStreakDate = today;
}

function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'leveling-system-data.json';
  a.click();
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      state = JSON.parse(e.target.result);
      saveState(); renderAll();
      showNotification('‚úÖ', 'Datos importados correctamente');
    } catch(err) {
      alert('Error al leer el archivo.');
    }
  };
  reader.readAsText(file);
}

function resetData() {
  localStorage.removeItem('leveling_state');
  location.reload();
}

// ============================================================
// START
// ============================================================
init();
</script>
<!-- FORGIVE PENALTY MODAL -->
<div class="modal-overlay" id="forgive-modal">
  <div class="modal" style="width:420px;">
    <div class="modal-header">
      <div class="modal-title" style="color:var(--gold);">‚öñÔ∏è Solicitar Perd√≥n</div>
      <button class="modal-close" onclick="closeForgiveModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="background:rgba(200,16,46,0.08);border:1px solid rgba(200,16,46,0.2);border-radius:6px;padding:12px;margin-bottom:14px;">
        <div style="font-size:11px;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Penalizaci√≥n pendiente</div>
        <div style="font-size:14px;color:var(--text);" id="forgive-quest-name">‚Äî</div>
        <div style="font-size:12px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-top:4px;" id="forgive-xp-amount">-0 XP</div>
      </div>
      <div class="form-group">
        <label class="form-label">Motivo justificado</label>
        <textarea class="form-textarea" id="forgive-reason" placeholder="Explica por qu√© no pudiste completarlo. Solo usa esto en casos realmente justificados..." style="min-height:90px;"></textarea>
      </div>
      <div style="font-size:11px;color:var(--text3);margin-bottom:14px;line-height:1.5;">
        ‚ö†Ô∏è El perd√≥n debe usarse con honestidad. Abusar de √©l elimina el prop√≥sito del sistema.
      </div>
      <div class="btn-row">
        <button class="btn-secondary" onclick="closeForgiveModal()">Cancelar ‚Äî aplicar penalizaci√≥n</button>
        <button class="btn-primary" style="background:rgba(212,160,23,0.2);border:1px solid var(--gold);color:var(--gold);" onclick="confirmForgive()">‚öñÔ∏è Perdonar</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
